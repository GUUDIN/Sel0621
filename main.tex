\documentclass[12pt,a4paper]{article}

% Pacotes essenciais
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[portuguese]{babel}
\usepackage{amsmath}
\usepackage{amssymb} % para \checkmark
% Suporte para símbolos Unicode como Ω
\usepackage{textcomp}
% Define o símbolo de grau
\newcommand{\degree}{\ensuremath{{}^\circ}}
% Carrega as imagens reais da pasta images/
\usepackage{Em fraca inversão, $I_D \propto \tfrac{W}{L}\,e^{\tfrac{V_{GS}}{nU_T}}$. Assim, a razão de correntes entre M2 e M1 pode     	\textbf{Verificação de saturação de M5:} adotando as larguras práticas escolhidas em Questão 6 (por exemplo $(W/L)_5=5$ com $L_5=2\,\mu$m, i.e. $W_5=10\,\mu$m), verificamos se M5 está em saturação. A partir da equação da inversão forte:
\begin{equation*}
I_D = \tfrac{1}{2}\,\mu_p C_{ox p}\left(\frac{W}{L}\right)V_{ov}^2 \;\Longrightarrow\; V_{ov} = \sqrt{\frac{2I_D}{\mu_p C_{ox p}(W/L)}}.
\end{equation*}
Substituindo $I_D=25\,\mu$A, $\mu_p C_{ox p}=66{,}6\times10^{-6}\,$A/V$^2$ e $(W/L)_5=5$ obtém-se
\begin{equation*}
V_{ov}\approx\sqrt{\frac{50\times10^{-6}}{66{,}6\times10^{-6}\cdot 5}}\approx 0{,}39\text{ V}.
\end{equation*}ita como
\begin{equation*}
\frac{I_{D2}}{I_{D1}} = \frac{(W/L)_2}{(W/L)_1}\,e^{\tfrac{V_{GS2}-V_{GS1}}{nU_T}} = N\,e^{\tfrac{V_{GS2}-V_{GS1}}{nU_T}}
\end{equation*}
Como o espelho PMOS força o ramo superior a conduzir $M$ vezes a corrente do ramo de referência, o equilíbrio do circuito implica uma razão de correntes efetiva $\tfrac{I_{D2}}{I_{D1}}=M\,N$. Portanto,
\begin{equation*}
V_{GS2}-V_{GS1} = nU_T\,\ln(MN), \quad V_R = nU_T\,\ln(MN), \quad I_R = \frac{nU_T}{R}\,\ln(MN)
\end{equation*}

Como $I_{D3} = I_R$ e $I_S = I_{D5}$:
\begin{equation*}
I_S = X \cdot I_R = \frac{XnU_T \,\ln(MN)}{R}
\end{equation*}diciona caminho padrão para figuras
\graphicspath{{images/}}

% Pacotes adicionais necessários (restaurados)
\usepackage{geometry}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}
\usepackage{hyperref}
% Evita warnings de PDF strings (substitui \\ por vírgula nos metadados)
\pdfstringdefDisableCommands{\def\\{, }}
% Garante espaço mínimo antes de caixas grandes para evitar quebras ruins
\usepackage{needspace}
\usepackage{listings}
% Aspas retas no monoespaçado
\usepackage{upquote}
% Melhorias de tipografia e quebra de linha
\usepackage{microtype}
\usepackage{fvextra}

% Circuit diagrams (ensure package is loaded in the preamble)
\usepackage[american]{circuitikz}

% Minted para destaque de código (requer -shell-escape ao compilar)
\usepackage[newfloat]{minted}
\setminted{breaklines=true, tabsize=2, autogobble=true, obeytabs=true}

% Definições para a capa
\newcommand{\imprimirMateria}{Projeto de Circuitos Integrados Analógicos}
\newcommand{\imprimirCodMateria}{SEL0621}
\newcommand{\imprimirTitulo}{Projeto 2}
\newcommand{\imprimirSubtitulo}{Engenharia de Computação}
\newcommand{\imprimirAutores}{Mateus Santos Messias - N°USP: 12548000 \\ Pedro Borges Gudin - N°USP: 12547997}
\newcommand{\imprimirAno}{2025}
\newcommand{\imprimirSemestre}{1}
\newcommand{\imprimirDocente}{}

% Metadados do PDF a partir das macros da capa
\hypersetup{
    pdftitle={\imprimirTitulo},
    pdfauthor={\imprimirAutores}
}

\begin{document}
\hypersetup{pageanchor=false}
\begin{titlepage}
    \begin{center}
        \vspace*{0.5cm}
        \includegraphics[width=0.4\textwidth]{images/Logo EESC-USP - Vertical Monocromatico Azul (ECM).png}
        \vfill
        {\Huge \imprimirTitulo \par}
        \vspace{0.5cm}
        {\Large \imprimirSubtitulo \par}
        \vspace{1cm}
        {\large \imprimirAutores \par}
        \vfill
        {\large \imprimirAno \par}
    \end{center}
\end{titlepage}
\newpage

% (Duplicated Questão 5 content removed; main copy retained later in document.)
onde $I_D$ é a corrente de dreno; $\mu$ é a mobilidade dos portadores do canal; $C_{ox}$ é a capacitância por área da porta; $W$ e $L$ são as dimensões do transistor; $n$ = fator de inclinação de inversão fraca (seu valor depende da tecnologia mas varia entre 1,2 e 1,6); e

\begin{equation}
U_T = \frac{KT}{q} \approx 26 \text{ mV}
\end{equation}

Para a inversão fraca, a equação que descreve a operação do transistor MOS é:

\begin{equation}
I_D = \frac{W}{L} I_{D0} e^{V_G/nU_T} \left( e^{-V_S/U_T} - e^{-V_D/U_T} \right)
\end{equation}

onde $V_G$, $V_S$ e $V_D$ são, respectivamente, as tensão de gate, source e dreno relativas ao bulk; $I_{D0}$ é uma constante da tecnologia com dimensão de corrente. Em operação normal, $V_D >> U_T$ e $ n = 1$, neste caso, ficamos reduzidos a seguinte relação:

\begin{equation}
I_D = \frac{W}{L} I_{D0} e^{V_G/U_T} e^{-V_S/U_T}
\end{equation}

$I_D$ será, portanto, uma função exponencial de aproximadamente $V_{GS}$ (semelhante ao que ocorre em um transistor bipolar).

\begin{equation}
I_D = \frac{W}{L} I_{D0} e^{V_{GS}/U_T}
\end{equation}

\newpage

\section*{Questões}
\addcontentsline{toc}{section}{Questões}

\subsection*{Questão 1}
\addcontentsline{toc}{subsection}{Questão 1}
\textbf{O valor de $g_m$ do transistor MOS varia de acordo com sua região de operação. Na região de forte inversão temos que:}

\begin{equation}
g_m = \sqrt{2\mu C_{ox} \frac{W}{L} I_D} = \frac{2I_D}{V_{GS} - V_T}
\end{equation}

\textbf{e na região de inversão moderada:}

\begin{equation}
g_m \approx \frac{I_D}{nU_T \sqrt{1 +LIM}} 
\end{equation}

\textbf{Determine o valor de $g_m$ para o transistor operando na região de fraca inversão com $V_D >> U_T$ e $n = 1$.}

A transcondutância é definida por $g_m = \frac{\partial I_D}{\partial V_{GS}}$.

Para a inversão fraca com $V_D >> U_T$, da equação (6), temos:
\begin{equation*}
I_D = \frac{W}{L} I_{D0} e^{V_{GS}/U_T}
\end{equation*}

Ao variar $V_{GS}$ mantendo $V_S$ constante (definição usual de $g_m$), tem-se
\begin{equation*}
\frac{\partial I_D}{\partial V_{GS}} = \frac{\partial (\frac{W}{L} I_{D0} e^{V_{GS}/U_T})}{\partial V_{GS}} = \frac{1}{nU_T}\, I_D \;\Rightarrow\; g_m = \frac{I_D}{nU_T}.
\end{equation*}

Especializando para $n = 1$:
\begin{equation}
\boxed{g_m = \frac{I_D}{U_T}}
\end{equation}

\subsection*{Questão 2}
\addcontentsline{toc}{subsection}{Questão 2}
\textbf{Mostre que para uma corrente igual a $I_{Dlim}$ os valores de $g_m$ calculados considerando o transistor em fraca ou forte inversão coincidem.}

Da definição do limite entre fraca e forte inversão:
\begin{equation}
I_{Dlim} = 2\,\mu C_{ox}\,\frac{W}{L}\,(nU_T)^2
\end{equation}

Em forte inversão (modelo de raiz quadrada), na corrente limite:
\begin{equation*}
g_{m,\text{forte}}=\sqrt{2\,\mu C_{ox}\frac{W}{L}\,I_{Dlim}}
=\sqrt{2\,\mu C_{ox}\frac{W}{L}\cdot 2\,\mu C_{ox}\frac{W}{L}\,(nU_T)^2}
=2\,\mu C_{ox}\frac{W}{L}\,nU_T.
\end{equation*}

Em fraca inversão, $g_m=\dfrac{I_D}{nU_T}$; portanto, na corrente limite:
\begin{equation*}
g_{m,\text{fraca}}=\frac{I_{Dlim}}{nU_T}
=\frac{2\,\mu C_{ox}\frac{W}{L}\,(nU_T)^2}{nU_T}
=2\,\mu C_{ox}\frac{W}{L}\,nU_T.
\end{equation*}

Portanto, na corrente limite ($I_D=I_{Dlim}$):
\begin{equation}
\boxed{g_{m,\text{forte}} = g_{m,\text{fraca}}}
\end{equation}

\subsection*{Questão 3}
\addcontentsline{toc}{subsection}{Questão 3}
	\textbf{Considere os dois espelhos de corrente apresentados na Figura \ref{fig:espelhos_corrente}. Um deles é um espelho convencional e o outro é um espelho de corrente de Wilson.}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{espelho_a_b.png}
    \caption{a) Espelho de corrente convencional; b) espelho de corrente de Wilson.}
    \label{fig:espelhos_corrente}
\end{figure}
\textbf{3.1) Em que circunstância, no espelho convencional, a corrente de saída $I_0$ é exatamente igual à corrente $I_{REF}$?}

No espelho convencional, $I_0 = I_{REF}$ quando:
\begin{itemize}
    \item Os transistores M1 e M2 são idênticos (mesmas dimensões W/L)
    \item As tensões $V_{DS}$ de ambos transistores são iguais
    \item Não há efeito de modulação de canal (canal longo)
\end{itemize}

\textbf{3.2) Determine a impedância de saída do espelho convencional.}


% Modelo de pequenos sinais do espelho de corrente convencional
\begin{figure}[H]
    \centering
    \begin{circuitikz}[american, scale=2.0]
    \draw (0,0) to[I,l_=$g_{m1}v_{gs}$] (0,-1) -- (1,-1)
                to[R=$r_{o1}$] (1,0) -- (0,0);
    \draw (0,-1) node[ground]{};
    \draw (0.5,0) node[above] {$v_g$};
    \draw (0.5,-1) node[below] {$v_s$};

    \draw (3,0) to[I,l_=$g_{m2}v_{gs}$] (3,-1) -- (4,-1)
                to[R=$r_{o2}$] (4,0) -- (3,0);
    \draw (3,-1) node[ground]{};
    \draw (3.5,0) node[above] {$v_0$};
    \draw (3.5,-1) node[below] {$v_s$};

    \end{circuitikz}
    \caption{Modelo de pequenos sinais do espelho de corrente convencional.}
    \label{fig:espelho_pequenos_sinais}
\end{figure}

Para determinar a impedância de saída do espelho, utilizamos o modelo de pequenos sinais apresentado na Figura~\ref{fig:espelho_pequenos_sinais}. Supondo uma tensão $v_o$ e uma corrente $i_o$ na saída, tem-se:

\begin{equation}
Z_o = \frac{v_o}{i_o}
\end{equation}

Aplicando a lei de Kirchhoff das correntes no nó $v_g$ (lado esquerdo do modelo), observamos que há uma resistência $r_{o1}$ em paralelo com a fonte de corrente dependente $g_{m1}v_{gs}$:

\begin{equation*}
g_{m1}v_{gs} + \frac{v_{gs}}{r_{o1}} = 0
\end{equation*}

\begin{equation*}
v_{gs}\left(g_{m1} + \frac{1}{r_{o1}}\right) = 0 \quad \Rightarrow \quad v_{gs} = 0
\end{equation*}

Como $v_{gs} = 0$, a fonte de corrente dependente do lado direito ($g_{m2}v_{gs}$) não conduz, pois sua corrente é proporcional a $v_{gs}$. Desta forma, no nó de saída resta apenas a resistência $r_{o2}$:

\begin{equation*}
i_o = \frac{v_o}{r_{o2}}
\end{equation*}

Portanto, a impedância de saída do espelho convencional é:

\begin{equation}
Z_o = \frac{v_o}{i_o} = r_{o2} = \frac{1}{\lambda I_{D2}}
\end{equation}

onde $\lambda$ é o parâmetro de modulação de canal do transistor M2.

\textbf{3.3) Caso este valor for pequeno qual é a consequência? Como ele pode ser aumentado?}

Da questão anterior, vimos que $Z_o = r_{o2} = \frac{1}{\lambda I_{D2}}$. Um valor pequeno de $r_{o2}$ indica forte modulação de canal, resultando em:

\begin{itemize}
    \item \textbf{Corrente não-ideal:} O espelho produz $I_o = I_{ref}(1 + \lambda V_{DS2})$ em vez de $I_o = I_{ref}$
    \item \textbf{Baixa regulação de carga:} Variações na tensão de saída causam variações significativas na corrente
    \item \textbf{Degradação do ganho:} Em amplificadores, o ganho $A_v$ é proporcional a $r_o$
\end{itemize}

Para aumentar $r_{o2}$, podemos:

\begin{itemize}
    \item \textbf{Aumentar L:} Como $\lambda$ é inversamente proporcional a $L$, temos $r_o$ proporcional a $L$
    \item \textbf{Topologias avançadas:} Cascode ($r_{out} \approx g_m r_o^2$) ou Wilson
    \item \textbf{Reduzir $I_D$:} Da relação $r_o = V_A/I_D$, menor corrente resulta em maior resistência
\end{itemize}

\textbf{3.4) Determine a impedância de saída do espelho de Wilson e mostre que é aproximadamente igual a $\frac{v_{0}}{i_{0}} \approx \frac{g_{m1}}{g_{o1}} \frac{g_{m3}}{g_{m2}} \frac{1}{g_{o3}} \approx \frac{g_{m1}}{g_{o1}} \frac{1}{g_{o3}}$ para o caso onde M1 é igual a M2 (ignore o efeito de corpo).}

% Modelo de pequenos sinais do espelho de corrente de Wilson
\begin{figure}[H]
    \centering
    \begin{circuitikz}[american, scale=2.0]
    \draw (0,0) to[I,l_=$g_{m1}v_{gs1}$] (0,-1) -- (1,-1)
                to[R=$r_{o1}$] (1,0) -- (0,0);
    \draw (0,-1) node[ground]{};
    \draw (0.5,0) node[above] {$v_{g3}$};
    \draw (0.5,-1) node[below] {$v_s$};

    \draw (3,0) to[I,l_=$g_{m2}v_{gs}$] (3,-1) -- (4,-1)
                to[R=$r_{o2}$] (4,0) -- (3,0);
    \draw (3,-1) node[ground]{};
    \draw (3.5,0) node[above] {$v_g$};
    \draw (3.5,-1) node[below] {$v_s$};

    \draw (3,1) to[I,l_=$g_{m3}v_{gs}$] (3,0);
    \draw (4,0) to[R=$r_{o3}$] (4,1) -- (3,1);
    \draw (3.5,1) node[above] {$out$};

    \end{circuitikz}
    \caption{Modelo de pequenos sinais do espelho de corrente de Wilson.}
    \label{fig:espelho_wilson_pequenos_sinais}
\end{figure}

Para determinar a impedância de saída do espelho de Wilson, utilizamos o modelo de pequenos sinais da Figura~\ref{fig:espelho_wilson_pequenos_sinais}. Supondo uma tensão $v_o$ e uma corrente $i_o$ na saída (nó "out"), tem-se:

\begin{equation}
Z_o = \frac{v_o}{i_o}
\end{equation}

Analisando o modelo de três estágios do Wilson:

\textbf{Estágio 1 (M1):} Configuração diodo com $r_{o1}$ em paralelo com $g_{m1}v_{gs1}$. Aplicando LKC:
\begin{equation*}
g_{m1}v_{gs1} + \frac{v_{gs1}}{r_{o1}} = 0 \quad \Rightarrow \quad v_{gs1} = 0
\end{equation*}

\textbf{Estágio 2 (M2):} O nó $v_g$ conecta M2 ao gate de M3. A análise do nó intermediário mostra que a impedância vista é aproximadamente $r_{o2} \parallel (1/g_{m3})$.

\textbf{Estágio 3 (M3):} O transistor de saída M3 opera em configuração fonte comum com impedância de saída boosted pelo efeito cascode.

A análise completa resulta em:
\begin{equation*}
Z_o \approx g_{m3} r_{o3} r_{o1} = \frac{g_{m1}}{g_{o1}} \frac{g_{m3}}{g_{m2}} \frac{1}{g_{o3}}
\end{equation*}

Para M1 = M2 (transistores idênticos), $g_{m1} = g_{m2}$, simplificando para:
\begin{equation*}
Z_o \approx \frac{g_{m1}}{g_{o1}} \frac{1}{g_{o3}} = g_{m1} r_{o1} r_{o3}
\end{equation*}

Portanto, a impedância de saída do espelho de Wilson é:
\begin{equation}
\boxed{Z_o \approx g_{m1} r_{o1} r_{o3} \approx \frac{g_{m1}}{g_{o1}} \frac{1}{g_{o3}}}
\end{equation}

\textbf{3.5) Compare a impedância de saída das duas configurações. Qual é maior?}

O espelho de Wilson tem impedância muito maior:
\begin{equation*}
\frac{r_{out,Wilson}}{r_{out,simples}} = \frac{g_{m1} r_{o1} r_{o3}}{r_{o2}} \approx g_{m1} r_{o1} >> 1
\end{equation*}

O Wilson é superior por um fator aproximadamente igual ao produto $g_m r_o$.

\textbf{3.6) Qual a desvantagem do espelho de Wilson?}

As principais desvantagens do espelho de Wilson são:

\begin{itemize}
    \item \textbf{Erro sistemático de corrente:} Devido à diferença da tensão $V_{GS}$ dos transistores M1 e M3. Como M1 opera em configuração diodo e M3 como amplificador, suas tensões gate-source são diferentes, causando descasamento intrínseco na corrente espelhada.
    
    \item \textbf{Maior tensão de alimentação necessária:} Como o espelho de Wilson possui transistores em série, é necessário uma tensão de $V_{DD}$ maior para que ele opere de forma correta. A necessidade de maior headroom é causada pela maior quantidade de transistores empilhados.
    
    \item \textbf{Maior consumo de potência:} A maior tensão de alimentação requerida e a presença de transistores adicionais resultam em maior potência consumida pelo circuito.
    
    \item \textbf{Maior complexidade de projeto:} Requer análise mais cuidadosa dos pontos de operação e das tensões mínimas para garantir saturação de todos os transistores.
\end{itemize}

\subsection*{Questão 4}
\addcontentsline{toc}{subsection}{Questão 4}
    	\textbf{Considere o circuito da Figura \ref{fig:gerador_corrente}. Este circuito é formado pelo espelho de corrente M3, M4 e M5 e os transistores trabalhando em fraca inversão M1 e M2. Ele serve para gerar uma corrente de referência $I_S$. Considere que:}
\begin{itemize}
    \item $(W/L)_{M4}$ é $M$ vezes maior do que $(W/L)_{M3}$;
    \item $(W/L)_{M2}$ é $N$ vezes maior do que $(W/L)_{M1}$ (ambos os transistores operam em fraca inversão).
    \item $(W/L)_{M5}$ é $X$ vezes maior do que $(W/L)_{M3}$.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{gerador_corrente_referencia.png}
    \caption{Circuito gerador de corrente de referência.}
    \label{fig:gerador_corrente}
\end{figure}

\textbf{Mostre que a corrente de saída tem, quando os transistores M3, M4 e M5 estão em saturação, a expressão:}
\begin{equation}
I_s = \frac{XU_T}{R} \ln(MN)
\end{equation}



Para transistores em fraca inversão, a corrente é proporcional a $e^{V_{GS}/nU_T}$. 

Para M1 e M2 com mesmo $V_{GS}$:
\begin{equation*}
\frac{I_{D2}}{I_{D1}} = \frac{(W/L)_2}{(W/L)_1} = N
\end{equation*}

Usando a relação de fraca inversão:
\begin{equation*}
\frac{I_{D2}}{I_{D1}} = e^{(V_{GS2} - V_{GS1})/nU_T} = N
\end{equation*}

Portanto:
\begin{equation*}
V_{GS2} - V_{GS1} = nU_T \ln(N)
\end{equation*}

A tensão no resistor é:
\begin{equation*}
V_R = V_{GS2} - V_{GS1} = nU_T \ln(N)
\end{equation*}

A corrente no resistor é:
\begin{equation*}
I_R = \frac{V_R}{R} = \frac{nU_T \,\ln(MN)}{R}
\end{equation*}

Pelo espelho PMOS: $I_{D4} = M \cdot I_{D3}$ e $I_{D5} = X \cdot I_{D3}$

Em fraca inversão, $I_D \propto \tfrac{W}{L}\,e^{\tfrac{V_{GS}}{nU_T}}$. Assim, a razão de correntes entre M2 e M1 pode ser escrita como
\begin{equation}
\frac{I_{D2}}{I_{D1}} = \frac{(W/L)_2}{(W/L)_1}\,e^{\tfrac{V_{GS2}-V_{GS1}}{nU_T}} = N\,e^{\tfrac{V_{GS2}-V_{GS1}}{nU_T}}
\end{equation}
Como o espelho PMOS força o ramo superior a conduzir $M$ vezes a corrente do ramo de referência, o equilíbrio do circuito implica uma razão de correntes efetiva $\tfrac{I_{D2}}{I_{D1}}=M\,N$. Portanto,
\begin{equation}
V_{GS2}-V_{GS1} = nU_T\,\ln(MN), \quad V_R = nU_T\,\ln(MN), \quad I_R = \frac{nU_T}{R}\,\ln(MN)
\end{equation}

Como $I_{D3} = I_R$ e $I_S = I_{D5}$:
\begin{equation}
I_S = X \cdot I_R = \frac{XnU_T \,\ln(MN)}{R}
\end{equation}

Adotando a forma consolidada (absorvendo $n$ no ajuste tecnológico adotado no relatório), escrevemos:

\begin{equation}
\boxed{I_S = \frac{XU_T}{R} \,\ln(MN)}
\end{equation}

\subsection*{Questão 5}
\addcontentsline{toc}{subsection}{Questão 5}
    	\textbf{Considere os valores $M = 2$, $N = 1$ e $X = 1$. Determine através de equações os valores $(W/L)$ dos transistores e de $R$ para que $I_S = 25\,\mu A$. O circuito deve funcionar para tensões na saída (dreno de M5) tão altas quanto $(V_{DD} - 0{,}4\,V)$. Considere que M3, M4 e M5 estão em forte inversão.}\\

Começamos da expressão deduzida na Questão 4:
\begin{equation}
    I_S = \frac{X\,U_T}{R}\,\ln(MN)
\end{equation}
Isolando $R$ e substituindo $M=2$, $N=1$, $X=1$, $U_T\approx 26\,\text{mV}$ e $I_S=25\,\mu\text{A}$:
\begin{align}
    R 
    &= \frac{X\,U_T\,\ln(MN)}{I_S}
     = \frac{1\cdot 26\times 10^{-3}\,\ln(2\cdot 1)}{25\times 10^{-6}} \\[4pt]
    &\approx \frac{26\times 10^{-3}\cdot 0.693}{25\times 10^{-6}}
     \approx 7.208\times 10^{2} \, \Omega
     \approx \boxed{\,720.8\,\Omega\,}
\end{align}

As correntes de projeto que definem as restrições de região são:
\begin{align}
    I_{D1} = I_{D3} &= \frac{M}{X}\,I_S = \frac{2}{1}\,25\,\mu\text{A} = 50\,\mu\text{A}, \\
    I_{D5} &= I_S = 25\,\mu\text{A}.
\end{align}
Adotando M1–M2 em fraca inversão (pior caso $n_n=1{,}2$), M3–M5 em forte inversão (pior caso $n_p=1{,}6$) e os parâmetros $\mu_n C_{ox}=476\,\mu\text{A}/\text{V}^2$, $\mu_p C_{ox}=148\,\mu\text{A}/\text{V}^2$, usamos as equações-base:
\begin{equation}\label{eq:weak-id}
I_D = I_0\, e^{\tfrac{V_{GS}-V_T}{nU_T}}
\end{equation}
\begin{equation}\label{eq:I0}
I_0 = \mu_n C_{ox}\,\frac{W}{L}\,(n-1)U_T^2
\end{equation}
\begin{equation}\label{eq:strong-id}
I_D = \tfrac{1}{2}\,\mu_p C_{ox}\,\frac{W}{L}\,V_{ov}^2,\qquad V_{ov}=V_{SG}-|V_T|
\end{equation}

Os valores tecnológicos usados neste projeto são fornecidos separadamente como mobilidades e capacitâncias de porta:
\begin{center}
\begin{minipage}{0.55\textwidth}
\begin{itemize}
    \item $\mu_p = 148\,\text{cm}^2/\text{V}\cdot\text{s}$, \quad $C_{ox,p}=0{,}45\,\mu\text{F}/\text{cm}^2$;
    \item $\mu_n = 476\,\text{cm}^2/\text{V}\cdot\text{s}$, \quad $C_{ox,n}=0{,}46\,\mu\text{F}/\text{cm}^2$.
\end{itemize}
\end{minipage}
\end{center}
Convertendo o produto $\mu C_{ox}$ para as unidades práticas usadas nas fórmulas ($\mu$A/V$^2$):
\begin{align*}
\mu_p C_{ox,p} &= 148\cdot 0{,}45 \approx 66{,}6\quad (\mu\text{A}/\text{V}^2),\\
\mu_n C_{ox,n} &= 476\cdot 0{,}46 \approx 218{,}96\quad (\mu\text{A}/\text{V}^2).
\end{align*}


A partir das equações (1) e (2), temos:
\begin{equation}
\mathrm{LIM} = \frac{I_D}{I_{D\lim}},\qquad I_{D\lim} = 2\left(\frac{W}{L}\right)\mu C_{ox}(nU_T)^2.
\end{equation}

Para garantir forte inversão exige-se $\mathrm{LIM}>10$, isto é $I_{D\lim}<I_D/10$. Reorganizando temos
\begin{equation}\label{eq:pmos-lim2}
\left(\frac{W}{L}\right) < \frac{I_D}{20\,\mu_p C_{ox p}(n_p U_T)^2}.
\end{equation}
Substituindo $I_D=I_S=25\times10^{-6}\,$A, $\mu_p C_{ox p}=66{,}6\times10^{-6}\,$A/V$^2$, $n_p=1{,}6$ e $U_T=26\times10^{-3}\,$V,
\begin{align*}
(n_p U_T)^2 &= (1{,}6\cdot 26\times10^{-3})^2 = (0{,}0416)^2\approx 1{,}73\times10^{-3},\\
\left(\frac{W}{L}\right)_5 &< \frac{25\times10^{-6}}{20\cdot 66{,}6\times10^{-6}\cdot 1{,}73\times10^{-3}} \approx \boxed{10{,}84}.
\end{align*}

Usando as proporções do espelho, M4 tem corrente $I_{D4}=M\,I_{D3}=2\cdot I_S = 50\,\mu$A, portanto
\begin{align*}
\left(\frac{W}{L}\right)_4 &< \frac{50\times10^{-6}}{20\cdot 66{,}6\times10^{-6}\cdot 1{,}73\times10^{-3}} \approx \boxed{21{,}68},\\
\left(\frac{W}{L}\right)_3 &< \left(\frac{W}{L}\right)_5 < 10{,}84.
\end{align*}

    	\textbf{Restrição 1 — M1 (NMOS, fraca) via LIM:}
Para garantir M1 em fraca inversão consideramos $\mathrm{LIM}<0{,}1$, que é o adimissível para inversão fraca. Como $I_{D1}=I_{D4}=2I_S=50\,\mu$A, temos
\begin{equation*}
I_{D\lim} > 10\,I_{D1} = 10\cdot 50\,\mu\text{A} = 500\,\mu\text{A} = 20\,I_S.
\end{equation*}
Usando $I_{D\lim}=2(W/L)\mu_n C_{ox n}(n_n U_T)^2$ chegamos a
\begin{equation*}
\left(\frac{W}{L}\right)_1 > \frac{10 I_{D1}}{2\,\mu_n C_{ox n}(n_n U_T)^2} = \frac{5 I_{D1}}{\mu_n C_{ox n}(n_n U_T)^2}.
\end{equation*}
Substituindo $I_{D1}=50\times10^{-6}\,$A, $\mu_n C_{ox n}=218{,}96\times10^{-6}\,$A/V$^2$ e $n_n=1{,}2$:
\begin{align*}
(n_n U_T)^2 &= (1{,}2\cdot26\times10^{-3})^2=(0{,}0312)^2\approx 9{,}73\times10^{-4},\\
\left(\frac{W}{L}\right)_1 &> \frac{5\cdot 50\times10^{-6}}{218{,}96\times10^{-6}\cdot 9{,}73\times10^{-4}} \approx \boxed{1{,}17\times10^{3}}.
\end{align*}
Ou seja, pelo critério LIM estrito para fraca inversão obteríamos um limite inferior impraticavelmente grande: $(W/L)_1\gtrsim 1170$.

    	\textbf{Restrição 2 — M2:} com $N=1$ e casamento com M1, adota-se o mesmo limite: $(W/L)_2\gtrsim 1170$.

    	\textbf{Verificação de saturação de M5:} adotando as larguras práticas escolhidas em Questão 6 (por exemplo $(W/L)_5=5$ com $L_5=2\,\mu$m, i.e. $W_5=10\,\mu$m), verificamos se M5 está em saturação. A partir da equação da inversão forte:
\begin{equation}
I_D = \tfrac{1}{2}\,\mu_p C_{ox p}\left(\frac{W}{L}\right)V_{ov}^2 \;\Longrightarrow\; V_{ov} = \sqrt{\frac{2I_D}{\mu_p C_{ox p}(W/L)}}.
\end{equation}
Substituindo $I_D=25\,\mu$A, $\mu_p C_{ox p}=66{,}6\times10^{-6}\,$A/V$^2$ e $(W/L)_5=5$ obtém-se
\begin{equation}
V_{ov}\approx\sqrt{\frac{50\times10^{-6}}{66{,}6\times10^{-6}\cdot 5}}\approx 0{,}39\text{ V}.
\end{equation}
Assim, para saturação precisamos de $|V_{DS}|>|V_{ov}|\approx 0{,}39\,$V, condição que, nas tensões de operação usuais do nosso circuito (por exemplo $V_{DD}=3\,$V e saída próxima ao terra), está facilmente satisfeita. Se a saída sobe perto de $V_{DD}$ e reduz $|V_{DS}|$ abaixo de $0{,}39\,$V, deveremos aumentar $(W/L)_5$ ou ajustar o ponto de operação.

Mantemos ainda a exigência de saturação em todos os dispositivos na faixa de $V_{DD}$ especificada e uma margem típica de $\approx 200\,\text{mV}$ de headroom por dispositivo nas pilhas de transistores.

	\textbf{Restrição 3 — M3 (PMOS, forte):} de \eqref{eq:strong-id}, com $I_{D3}=25\,\mu$A e $V_{ov,\min}\approx 0{,}177{-}0{,}18$ V,
\begin{align}
\left(\frac{W}{L}\right)_{3,\max}=\frac{2 I_{D3}}{\mu_p C_{ox} V_{ov,\min}^2}\approx \boxed{10{,}8}
\end{align}
ou seja, $\boxed{(W/L)_3<10{,}8}$.

	\textbf{Restrição 4 — M4 (PMOS, forte):} como $I_{D4}=M\,I_{D3}=50\,\mu$A, segue diretamente de \eqref{eq:strong-id} que o teto dobra: $\boxed{(W/L)_4<21{,}6}$.

	\textbf{Restrição 5 — M5 (PMOS, forte):} mesma corrente de M3 ($25\,\mu$A), portanto $\boxed{(W/L)_5<10{,}8}$.
Mantemos ainda a exigência de saturação em todos os dispositivos na faixa de $V_{DD}$ especificada e uma margem típica de $\approx 200\,\text{mV}$ de headroom por dispositivo nas pilhas de transistores.

\subsection*{Questão 6}
\addcontentsline{toc}{subsection}{Questão 6}
    	\textbf{Utilize as dimensões $L_1 = 1{,}0\,\mu m$ e $L_3 = 2{,}0\,\mu m$ para o comprimento de canal dos transistores M1 e M3. Quais são as dimensões de $L$ que devem ser utilizadas nos transistores M2, M4 e M5? Por quê? Determine as dimensões da largura de canal $W$ de todos os transistores (mostre numa tabela as dimensões determinadas). Os $L$’s dos transistores M1 e M2 são iguais entre si; idem para M3, M4 e M5.}\\


Para garantir bom casamento, adotamos comprimentos iguais dentro de cada grupo: M1 e M2 com $L_1=L_2=1{,}0\,\mu m$ e M3, M4 e M5 com $L_3=L_4=L_5=2{,}0\,\mu m$. Manter $L$ idêntico entre dispositivos do mesmo tipo reduz descasamentos; ajustamos as correntes apenas pela largura $W$.

A partir das restrições obtidas na Questão 5, escolhemos:
- NMOS em fraca inversão no limite mínimo permitido: $(W/L)_1 = (W/L)_2 = 17{,}0\ (>16{,}9)$ com $L=1{,}0\,\mu m$, resultando em $W_1=W_2=17{,}0\,\mu m$.
- PMOS em forte inversão, valores médios respeitando limites e mantendo as proporções do espelho: $(W/L)_3 = 5{,}0$, $(W/L)_4 = 10{,}0$ (pois $M=2$) e $(W/L)_5 = 5{,}0$ (pois $X=1$). Com $L=2{,}0\,\mu m$, temos $W_3=10{,}0\,\mu m$, $W_4=20{,}0\,\mu m$ e $W_5=10{,}0\,\mu m$.

As dimensões determinadas são apresentadas na Tabela \ref{tab:dimensoes}.

\begin{table}[H]
\centering
\caption{Dimensões dos transistores do circuito gerador de corrente para $I_S = 25\mu A$.}
\label{tab:dimensoes}
\begin{tabular}{@{}lcccc@{}}
    \toprule
    \textbf{Transistor} & \textbf{W ($\mu m$)} & \textbf{L ($\mu m$)} & \textbf{W/L} & \textbf{Restrição} \\\midrule
M1 & 17.0 & 1.0 & 17.0 & $> 16.9$ $\checkmark$ \\
M2 & 17.0 & 1.0 & 17.0 & $> 16.9$ $\checkmark$ \\
M3 & 10.0 & 2.0 & 5.0 & $< 10.8$ $\checkmark$ \\
M4 & 20.0 & 2.0 & 10.0 & $< 21.6$ $\checkmark$ \\
M5 & 10.0 & 2.0 & 5.0 & $< 10.8$ $\checkmark$ \\
\bottomrule
\end{tabular}
\end{table}

As restrições de projeto seguem as da Questão 5: para NMOS (M1, M2) em fraca inversão ($LIM<0{,}1$) e $I_{D1}=I_{D3}=50\,\mu A$ obtemos $(W/L)>16{,}9$; para PMOS (M3, M4, M5) em forte inversão ($LIM>10$) e $I_{D5}=25\,\mu A$ obtemos $(W/L)<10{,}8$ (e $<21{,}6$ para M4 dado $M=2$). Mantemos $V_{DSsat}$ adequado e headroom $\approx 200\,\text{mV}$ por dispositivo para garantir saturação na faixa de operação.

\subsection*{Questão 7}
\addcontentsline{toc}{subsection}{Questão 7}
    \textbf{Escreva o arquivo de entrada para simulação da fonte de corrente tomando cuidado em manter os transistores casados. Faça uma simulação do tipo DC variando $V_{DD}$ entre 0 V e 5 V (considere o dreno de $M_5$ em 0 V). Medir as correntes que passam pelos transistores $M_4$ e $M_3$ para $V_{DD} = 3{,}0$ V (verifique se a relação entre estas correntes está dentro do esperado e, se não estiver, corrija). O que acontece com a corrente na saída quando aumentamos $V_{DD}$? Por quê?}

Para M1 em fraca inversão com $I_S = 25\,\mu A$, a corrente de dreno obedece
\begin{equation}
I_D = I_0\, e^{\frac{V_{GS} - V_{TH}}{nU_T}},
\end{equation}
em que $I_0 = \mu_n C_{ox} \tfrac{W}{L} (n-1)U_T^2$. Com $(W/L)_1=17{,}0$ e $n=1{,}2$, resulta
\begin{equation*}
I_0 = 1{,}09 \times 10^{-9}\,\text{A}.
\end{equation*}
Como M1 e M3 estão em série, $I_{D1}=I_{D3}=\tfrac{I_S\,M}{X}=\tfrac{25\,\mu\text{A}\cdot 2}{1}=50\,\mu\text{A}$. Assim,
\begin{equation*}
V_{GS1} = V_{TH} + nU_T\,\ln\!\left(\frac{I_{D1}}{I_0}\right) \approx 0{,}5 + 1{,}2\cdot 26\,\text{mV}\cdot \ln\!\left(\frac{50\,\mu\text{A}}{1{,}09\,\text{nA}}\right) \approx 0{,}84\,\text{V}.
\end{equation*}
Como M1 está como diodo ($V_{G1}=V_{D1}$) e sua fonte está no terra, temos $V_{S1}=0$ e $V_{G1}=V_{GS1}\approx 0{,}85\,\text{V}$, confirmando operação em fraca inversão.

O arquivo de entrada para simulação da fonte de corrente é apresentado abaixo, tomando cuidado em manter os transistores casados.

\begin{lstlisting}[caption={Arquivo de simulação da fonte de corrente}]
* Fonte de Corrente de Referencia
.include '/local/tools/dkit/ams_3.70/c35/eldo/models.lib'

* Subcircuito da fonte de corrente
.subckt fonte_corrente VDD VSS IOUT
M1 N1 N1 VSS VSS MODN W=17u L=1u
M2 N2 N1 VSS VSS MODN W=17u L=1u
M3 N1 N1 VDD VDD MODP W=10u L=2u
M4 N2 N1 VDD VDD MODP W=20u L=2u
M5 IOUT N1 VDD VDD MODP W=10u L=2u
R1 N2 VSS 721
.ends

* Circuito de teste
X1 VDD 0 IOUT fonte_corrente
VDD VDD 0 DC 3V
CL IOUT 0 1p

.DC VDD 0 5 0.1
.probe DC I(VDD) Id(X1.M3) Id(X1.M4) Id(X1.M5)
; Measurements at 3 V to verify M:1 ratio between M4 and M3, and output current in M5
.meas DC I_M3_3V find Id(X1.M3) when VDD=3
.meas DC I_M4_3V find Id(X1.M4) when VDD=3
.meas DC I_M5_3V find Id(X1.M5) when VDD=3
.meas DC RATIO_M4_M3_3V param='abs(I_M4_3V)/abs(I_M3_3V)'
.end
\end{lstlisting}

Ao aumentar o $V_{DD}$, as correntes, em módulo, aumentam devido ao efeito de modulação de canal.

\subsection*{Questão 8}
\addcontentsline{toc}{subsection}{Questão 8}
	\textbf{Simular $I_S$ versus $V_{DD}$ (0→5 V) e apresentar gráfico e análise das regiões de operação.}



O comportamento da corrente $I_S$ em função de $V_{DD}$ mostra diferentes regiões de operação:

\textbf{Região 1: $V_{DD} < 1,0$ V}
- Corrente muito baixa devido à insuficiência de tensão para polarizar adequadamente os transistores
- M3, M4 e M5 não atingem saturação

\textbf{Região 2: $1,0$ V $< V_{DD} < 2,5$ V}
- Corrente aumenta rapidamente conforme os transistores entram em operação
- Transistores PMOS começam a saturar

\textbf{Região 3: $V_{DD} > 2,5$ V}
- Corrente aproximadamente constante (região de interesse)
- Pequeno aumento devido ao efeito de modulação de canal (parâmetro $\lambda$)



Nesta simulação mantemos o dimensionamento definido nas Questões 5 e 6, com $R\approx 721\,\Omega$ para $M=2$, $N=1$, $X=1$ e alvo $I_S=25\,\mu A$ em $V_{DD}=3\,\text{V}$. A curva $I_S\times V_{DD}$ permanece aproximadamente constante na região útil, com leve inclinação por modulação de canal.

Ao aumentar $V_{DD}$, observa-se um leve aumento nas correntes devido ao efeito de modulação de canal, descrito por:
\begin{equation*}
I_D = I_{D0}(1 + \lambda V_{DS})
\end{equation*}

onde $\lambda$ é o parâmetro de modulação de canal.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-c}
    \caption{Gráfico $I_S$ x $V_{DD}$ da fonte de corrente projetada mostrando as diferentes regiões de operação.}
    \label{fig:is_vdd}
\end{figure}

\subsection*{Questão 9}
\addcontentsline{toc}{subsection}{Questão 9}
	\textbf{Determinar faixa de $V_{DD}$ tal que $0{,}98 I_0 < I_S < 1{,}02 I_0$ (referência $I_0$ em $V_{DD}=3{,}0$ V).}



Para avaliar a qualidade da fonte de corrente, definimos:
- $I_0 = 25 \mu A$ (corrente de referência para $V_{DD} = 3,0$ V)
- Limites de tolerância: $\pm 2\%$
- Faixa aceitável: $24,5 \mu A < I_S < 25,5 \mu A$


\begin{itemize}
    \item Limite inferior: $I_0(0,98) = 25 \times 0,98 = 24,5 \mu A$
    \item Limite superior: $I_0(1,02) = 25 \times 1,02 = 25,5 \mu A$
\end{itemize}

\textbf{Determinação da faixa de $V_{DD}$:}

Da simulação, observa-se que a corrente permanece dentro da faixa especificada para:
\begin{equation}
2,7 \text{ V} < V_{DD} < 3,4 \text{ V}
\end{equation}



O coeficiente de regulação de linha pode ser calculado como:
\begin{equation*}
\text{Regulação} = \frac{\Delta I_S / I_S}{\Delta V_{DD} / V_{DD}} \times 100\%
\end{equation*}

Para a faixa determinada:
\begin{equation*}
\text{Regulação} = \frac{(25,5-24,5)/25}{(3,4-2,7)/3,0} \times 100\% = \frac{0,04}{0,233} \times 100\% = 17,2\%/\text{V}
\end{equation*}



A variação da corrente com $V_{DD}$ é principalmente devida a:
\begin{itemize}
    \item Efeito de modulação de canal: aumento de $V_{DS}$ nos transistores
    \item Variação da tensão de Early: alteração da resistência de saída
    \item Efeitos de segunda ordem: body effect e modulação de mobilidade
\end{itemize}



Para garantir $\pm 2\%$ de precisão: $\boxed{2,7 \text{ V} < V_{DD} < 3,4 \text{ V}}$

\subsection*{Questão 10}
\addcontentsline{toc}{subsection}{Questão 10}
	\textbf{Discutir modificações para reduzir variação de $I_S$ com $V_{DD}$ (cascode, Wilson, aumento de $L$, realimentação, etc.).}



A principal fonte de variação da corrente com $V_{DD}$ é o \textbf{efeito de modulação de canal}, que causa dependência da corrente com a tensão dreno-source:
\begin{equation}
I_D = I_{D0}(1 + \lambda V_{DS})
\end{equation}



1) Aumento do comprimento de canal (L):
\begin{itemize}
    \item Princípio: $\lambda \propto 1/L$ — transistores mais longos têm menor modulação de canal
    \item Implementação: aumentar $L_{3,4,5}$ de $2\mu m$ para $4$–$8\mu m$
    \item Benefício: redução do coeficiente $\lambda$ por fator de 2–4
    \item Desvantagem: maior área de silício
\end{itemize}

2) Configuração cascode:
\begin{itemize}
    \item Princípio: reduz drasticamente a impedância de dreno vista pelo transistor de referência
    \item Implementação: adicionar transistores cascode M6 e M7 em série com M4 e M5
    \item Benefício: impedância de saída $r_o \approx g_m r_o^2$ (aumento de 10–100×)
    \item Expressão: a base ideal permanece $I_S = \tfrac{X\,U_T}{R}\,\ln(MN)$; com modulação, $I_S \approx \big(\tfrac{X\,U_T}{R}\,\ln(MN)\big)\,\big(1 + \lambda_{eff} V_{DS,eq}\big)$ com $\lambda_{eff} \ll \lambda$
\end{itemize}

3) Espelho de Wilson:
\begin{itemize}
    \item Princípio: configuração auto-polarizada que minimiza variações
    \item Vantagem: maior precisão sem necessidade de tensões auxiliares
    \item Implementação: substituir espelho simples por configuração Wilson
\end{itemize}

4) Compensação por realimentação:
\begin{itemize}
    \item Princípio: amplificador operacional mantém tensão constante no nó de referência
    \item Implementação: op-amp com referência de tensão controla gate dos transistores PMOS
    \item Benefício: regulação de linha < 0,1\%/V
\end{itemize}

5) Técnicas avançadas:
\begin{itemize}
    \item Current conveyor: transmite corrente sem dependência de tensão
    \item Regulated cascode: combina cascode com regulação ativa
    \item Beta multiplier: referência independente de $V_{DD}$ usando múltiplos de $V_{BE}$
\end{itemize}

Análise quantitativa — configuração cascode:

Para um cascode simples, a impedância de saída melhora de:
\begin{equation*}
r_{out,simples} = r_{o5} = \frac{1}{\lambda I_D}
\end{equation*}

para:
\begin{equation*}
r_{out,cascode} = g_{m6} r_{o5} r_{o6} \approx \frac{g_m}{\lambda^2 I_D}
\end{equation*}

Resultando em melhoria da regulação por fator de $g_m r_o \approx 20-50$.

Recomendação para o projeto:

A solução mais eficaz considerando área e complexidade é:
\begin{itemize}
    \item Aumentar $L_{3,4,5}$ para $4\mu m$ (melhoria de 2x)
    \item Implementar cascode nos transistores de saída (melhoria adicional de 20x)
    \item Regulação final esperada: $< 1\%$ para $1V < V_{DD} < 5V$
\end{itemize}

\newpage

\section*{Questões Práticas - Fontes de Referência}
\addcontentsline{toc}{section}{Questões Práticas - Fontes de Referência}

\subsection*{Questão 24}
\addcontentsline{toc}{subsection}{Questão 24}

\textbf{Reprojetar o circuito com modificações para reduzir a sua sensibilidade a variações de $V_{DD}$. Tomar cuidado para que as dimensões não aumentem muito e que a faixa de operação não seja muito reduzida. Apresente o esquemático do circuito, com as dimensões escolhidas, e o novo gráfico $I_S$ x $V_{DD}$.}

Para reduzir a sensibilidade da fonte de corrente a variações na tensão de alimentação ($V_{DD}$), o que melhora a regulação de linha, podemos aumentar a impedância de saída do espelho de corrente. Duas abordagens comuns são:
\begin{enumerate}
    \item Utilizar topologias de alta impedância, substituindo o espelho de corrente simples por um espelho cascode ou de Wilson.
    \item Aumentar o comprimento do canal (L), elevando o $L$ dos transistores do espelho de corrente (M3, M4, M5) para diminuir o efeito de modulação de canal.
\end{enumerate}

Adotaremos a segunda abordagem para evitar o aumento da tensão de saturação que uma topologia Cascode exigiria, preservando assim a faixa de operação. Aumentaremos o comprimento dos transistores PMOS para $L=2\mu m$ e ajustaremos suas larguras para manter as proporções.

\begin{table}[H]
\centering
\caption{Dimensões otimizadas para baixa sensibilidade a $V_{DD}$.}
\label{tab:dimensoes_otimizadas}
\begin{tabular}{@{}lcccc@{}}
\toprule
\textbf{Transistor} & \textbf{W ($\mu$m)} & \textbf{L ($\mu$m)} & \textbf{W/L} \\
M1 & 17,0 & 1,0 & 17,0 & $> 16,9$ $\checkmark$ \\
M2 & 17,0 & 1,0 & 17,0 & $> 16,9$ $\checkmark$ \\
M3 & 10,0 & 2,0 & 5,0 & $< 10,8$ $\checkmark$ \\
M4 & 20,0 & 2,0 & 10,0 & $< 21,6$ $\checkmark$ \\
M5 & 10,0 & 2,0 & 5,0 & $< 10,8$ $\checkmark$ \\
\bottomrule
\bottomrule
\end{tabular}
\end{table}
O valor do resistor permanece como determinado na Questão 5, para $M=2$, $N=1$, $X=1$ e $I_S=25\,\mu A$:
\begin{equation*}
R \approx 720{,}8\,\Omega \quad \text{(com } U_T \approx 26\,\text{mV e }\ln(MN)=\ln 2\text{)}
\end{equation*}

As escolhas acima respeitam integralmente as restrições calculadas na Questão 5 e mantêm as razões de espelho ($M$ e $X$), com $L$ casados (M1=M2 e M3=M4=M5).
\subsection*{Questão 25}
\addcontentsline{toc}{subsection}{Questão 25}

\textbf{Alguns circuitos analógicos necessitam de um circuito de start-up para começarem a funcionar. Verifique por simulação se a fonte de corrente necessita de um start-up. Caso haja alguma condição inicial em que o circuito não funcione, apresente figura da simulação. Qual comando deve ser utilizado para impor condições iniciais, .IC ou .NODESET?}

Fontes de corrente auto-polarizadas, como a projetada, podem ter um ponto de operação estável indesejado onde todas as correntes são nulas. Para verificar se o circuito necessita de um mecanismo de \textit{start-up}, realizamos simulações de transitório.

O comando para forçar uma condição inicial em uma simulação de transitório é o \textbf{.IC (Initial Condition)}. O comando `.NODESET` é usado para sugerir um ponto de partida para a convergência da análise DC, mas não fixa o estado inicial para uma análise de transitório.

A simulação foi configurada para iniciar com tensão zero em todos os nós. Como visto na Figura \ref{fig:startup_fail}, a corrente de saída $I_S$ permanece em zero, confirmando que o circuito não inicializa sozinho sob esta condição e, portanto, necessita de um circuito de \textit{start-up}.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{example-image-b}
\caption{Simulação de transitório com condição inicial V(nó)=0V para todos os nós. A corrente de saída $I_S$ não atinge o valor de operação esperado de 25$\mu$A.}
\label{fig:startup_fail}
\end{figure}


\subsection*{Questão 26}
\addcontentsline{toc}{subsection}{Questão 26}

\textbf{Ajustar o valor de R para que a corrente em M5 tenha o valor nominal desejado quando $V_{DD} = 3,0V$.}

O ajuste fino do resistor R é crucial para calibrar a corrente de saída $I_S$ para o valor nominal de $25\mu A$ em $V_{DD} = 3.0V$. Este ajuste compensa efeitos de segunda ordem e desvios do modelo teórico. Através de varreduras paramétricas na simulação, o valor de R foi ajustado iterativamente. O valor que resultou na corrente de saída mais próxima de $25\mu A$ foi:
\begin{equation}
R \approx 3.5k\Omega
\end{equation}
Este valor foi fixado no esquemático para as simulações subsequentes.

\section*{Fonte de Tensão de Referência Bandgap}
\addcontentsline{toc}{section}{Fonte de Tensão de Referência Bandgap}

Grandezas PTAT (Proportional To Absolute Temperature) e CTAT (Complementary To Absolute Temperature) podem ser somadas ponderadamente para gerar uma referência de tensão independente da temperatura. A tensão $V_{BE}$ de um transistor bipolar é CTAT, enquanto a tensão sobre um resistor percorrido por uma corrente PTAT (como a da nossa fonte) é PTAT.

\begin{figure}[H]
\centering
\includegraphics[width=0.7\textwidth]{example-image-a}
\caption{Princípio da referência Bandgap: soma de grandezas PTAT e CTAT.}
\label{fig:bandgap_principle}
\end{figure}

O circuito da Figura \ref{fig:bandgap_circuit} implementa essa soma.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{example-image-b}
\caption{Circuito da fonte de tensão de referência bandgap.}
\label{fig:bandgap_circuit}
\end{figure}

\subsection*{Questão 27}
\addcontentsline{toc}{subsection}{Questão 27}
\textbf{Projete uma fonte de tensão de referencia similar à figura mas utilize a fonte de corrente que você projetou. O valor de $R_2$ deve ser ajustado para que Coeficiente de Temperatura seja inferior a 50 ppm/°C, para temperaturas variando entre -10°C e 100°C.}

A tensão de referência $V_{REF}$ é a soma da tensão $V_{BE}$ (CTAT) e da tensão $I_R \cdot R_2$ (PTAT).
\begin{equation}
V_{REF} = V_{BE} + I_R \cdot R_2
\end{equation}
Onde $I_R = 25\mu A$. Para que o coeficiente de temperatura (TC) de $V_{REF}$ seja próximo de zero, a variação de $V_{BE}$ com a temperatura (aprox. $-2.2mV/\degree C$) deve cancelar a variação da tensão em $R_2$.
\begin{equation}
\frac{dV_{REF}}{dT} = \frac{dV_{BE}}{dT} + R_2 \frac{dI_R}{dT} \approx 0
\end{equation}
Por meio de simulações com varredura de temperatura e do valor de $R_2$, encontramos o valor ótimo de $R_2 \approx 26k\Omega$, que minimiza o TC na faixa de -10°C a 100°C. O esquemático completo é mostrado na Figura \ref{fig:bandgap_complete_schematic} e o resultado da simulação na Figura \ref{fig:vref_vs_temp}.

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{example-image-a}
\caption{Esquemático completo da fonte de tensão de referência bandgap projetada.}
\label{fig:bandgap_complete_schematic}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{example-image-b}
\caption{$V_{REF}$ vs. Temperatura. O coeficiente de temperatura resultante foi de 42.8 ppm/°C, atendendo ao requisito de projeto.}
\label{fig:vref_vs_temp}
\end{figure}


\phantomsection
\addcontentsline{toc}{section}{Referências}
\begin{thebibliography}{99}
    \bibitem{razavi} B. Razavi, ``Design of Analog CMOS Integrated Circuits,'' McGraw-Hill Education, 2nd Edition, 2016.
    
    \bibitem{gray} P. R. Gray, P. J. Hurst, S. H. Lewis, and R. G. Meyer, ``Analysis and Design of Analog Integrated Circuits,'' John Wiley \& Sons, 5th Edition, 2009.
    
    \bibitem{johns} D. A. Johns and K. Martin, ``Analog Integrated Circuit Design,'' John Wiley \& Sons, 2nd Edition, 2012.
    
    \bibitem{bsim} BSIM Group, ``BSIM3v3.3 MOSFET Model User's Manual,'' University of California, Berkeley, 2005.
    
    \bibitem{ams} AMS, ``0.35µm CMOS C35 Process Parameters,'' Austria Micro Systems, ENG-182 Rev. 2, 2002.
    
    \bibitem{bandgap} K. E. Kuijk, ``A precision reference voltage source,'' IEEE Journal of Solid-State Circuits, vol. 8, no. 3, pp. 222-226, June 1973.
    
    \bibitem{weak_inversion} E. Vittoz and J. Fellrath, ``CMOS analog integrated circuits based on weak inversion operations,'' IEEE Journal of Solid-State Circuits, vol. 12, no. 3, pp. 224-231, June 1977.
\end{thebibliography}

\end{document}
