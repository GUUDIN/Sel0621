\documentclass[12pt,a4paper]{article}

% Pacotes essenciais
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[brazilian]{babel}
\usepackage{amsmath}
\usepackage{amssymb} % para \checkmark
% Suporte para símbolos Unicode como Ω
\usepackage{textcomp}
% Define o símbolo de grau
\newcommand{\degree}{\ensuremath{{}^\circ}}
% Usa placeholders para todas as figuras (remova [demo] quando tiver imagens reais)
\usepackage[demo]{graphicx}
% Adiciona caminho padrão para figuras
\graphicspath{{images/}}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}
\usepackage{hyperref}
% Evita warnings de PDF strings (substitui \\ por vírgula nos metadados)
\pdfstringdefDisableCommands{\def\\{, }}
% Garante espaço mínimo antes de caixas grandes para evitar quebras ruins
\usepackage{needspace}
\usepackage{listings}
% Suporte a UTF-8 em lstlisting
%\usepackage{listingsutf8}
% Aspas retas no monoespaçado
\usepackage{upquote}
% Melhorias de tipografia e quebra de linha
\usepackage{microtype}
\usepackage{fvextra}

% -------- Opcional: engine Minted para melhor quebra de linhas em códigos --------
% Requer compilar com: -shell-escape (pdflatex/xelatex/lualatex)
% Se o ambiente não tiver Pygments, mantenha os listings padrão abaixo.
\usepackage[newfloat]{minted} % melhor quebra, destaque por Pygments
\setminted{breaklines=true, tabsize=2, autogobble=true, obeytabs=true}
\setmintedinline{breaklines=true}

\lstset{
  inputencoding=utf8,
  showstringspaces=false,
  keepspaces=true,
  columns=fullflexible,
}

% Cores e caixas para blocos de código
\usepackage[dvipsnames,table,xcdraw]{xcolor}
\usepackage[many]{tcolorbox}
\tcbuselibrary{listings, listingsutf8, skins, minted}
% Paleta estilo VS Code Dark+
\definecolor{navyBG}{HTML}{0A1E2E}
\definecolor{vscBlue}{HTML}{569CD6}
\definecolor{vscGreen}{HTML}{6A9955}
\definecolor{vscYellow}{HTML}{DCDCAA}
\definecolor{vscGray}{HTML}{CCCCCC}
\definecolor{vscText}{HTML}{FFFFFF}

% Paleta P&B para impressão
\definecolor{codeBack}{gray}{0.95}
\definecolor{codeFrame}{gray}{0.80}
\definecolor{codeNum}{gray}{0.40}
\definecolor{codeComment}{gray}{0.35}
\definecolor{codeString}{gray}{0.10}

% Estilo reutilizável para listings em P&B (facilita ajustes globais)
\lstdefinestyle{codebw}{%
  basicstyle=\ttfamily\scriptsize,
  numbers=left,
  numberstyle=\tiny\color{codeNum},
  numbersep=6pt,
  showstringspaces=false,
  keepspaces=true,
  columns=fullflexible,
  breaklines=true,
  breakatwhitespace=false,
  breakautoindent=false,
  breakindent=0pt,
  tabsize=2,
  xleftmargin=1.5em,
  prebreak=\mbox{\tiny$\hookleftarrow$},
  postbreak=\mbox{\tiny$\ldots$},
  commentstyle=\itshape\color{codeComment},
  stringstyle=\color{codeString},
  backgroundcolor=\color{codeBack}
}

% Define o ambiente codeblock para usar o estilo e melhorar quebras
\newtcblisting{codeblock}[1][]{%
  listing only,
  breakable=true, % <--- Garantido que está como true
  enhanced jigsaw, % motor de quebra profissional
  pad at break*=1mm, % pequeno respiro entre segmentos
  segmentation style={draw=none}, % oculta a linha tracejada
  width=\linewidth,
  enlarge left by=-1.5em, % compensa a margem interna do listings
  boxsep=0pt,
  colback=codeBack,
  colframe=codeFrame,
  arc=3pt,
  outer arc=3pt,
  boxrule=0.4pt,
  top=5pt,
  bottom=5pt,
  left=6pt,
  right=6pt,
  listing engine=listings,
  listing options={style=codebw},
  #1
}

% Ambiente alternativo com Minted (usa Pygments). Chame como: \begin{codeblockm}{python} ... \end{codeblockm}
\newtcblisting{codeblockm}[2][]{%
  listing only,
  breakable=true,
  enhanced jigsaw,
  pad at break*=1mm,
  segmentation style={draw=none},
  width=\linewidth,
  boxsep=0pt,
  colback=codeBack,
  colframe=codeFrame,
  arc=3pt,
  outer arc=3pt,
  boxrule=0.4pt,
  top=5pt,
  bottom=5pt,
  left=6pt,
  right=6pt,
  listing engine=minted,
  minted language=#2,
  minted options={fontsize=\scriptsize,linenos,numbersep=6pt,breaklines,tabsize=2,autogobble=true},
  title={#1}
}

% Uso:
% 1) Para máxima robustez de quebra, prefira o ambiente abaixo com Minted:
%    \begin{codeblockm}{text} ... \end{codeblockm}
%    \begin{codeblockm}[Código ELDO]{text} ... \end{codeblockm}
% 2) Compile com: pdflatex -shell-escape main.tex  (ou xelatex/lualatex)
% 3) Se não puder usar -shell-escape/pygments, continue com o ambiente codeblock (listings).

\usepackage{geometry}

% Configuração da fonte Times New Roman
\usepackage{mathptmx}

% Mapeamento de alguns caracteres Unicode comuns
\DeclareUnicodeCharacter{00BA}{\textordmasculine}
\DeclareUnicodeCharacter{2013}{--}
\DeclareUnicodeCharacter{00A0}{\space}

% Margens
\geometry{
 a4paper,
 total={170mm,257mm},
 left=20mm,
 top=20mm,
 }

% Informações do documento
% \title{Título do Trabalho} % (não usado; capa usa macros abaixo)
% \author{Mateus Santos Messias - 12548000  \and Pedro Borges Gudin - 12547997}
% \date{Agosto de 2025}

% Definições para a capa
\newcommand{\imprimirMateria}{Projeto de Circuitos Integrados Analógicos}
\newcommand{\imprimirCodMateria}{SEL0621}
\newcommand{\imprimirTitulo}{Projeto 2}
\newcommand{\imprimirSubtitulo}{Engenharia de Computação}
\newcommand{\imprimirAutores}{Mateus Santos Messias - N°USP: 12548000 \\ Pedro Borges Gudin - N°USP: 12547997}
\newcommand{\imprimirAno}{2025}
\newcommand{\imprimirSemestre}{1} % Baseado em 2024.1
\newcommand{\imprimirDocente}{} % Docente não informado na imagem

% Metadados do PDF a partir das macros da capa
\hypersetup{
  pdftitle={\imprimirTitulo},
  pdfauthor={\imprimirAutores}
}

\begin{document}

\begin{titlepage}
    \begin{center}
        \vspace*{0.5cm}
        \includegraphics[width=0.4\textwidth]{images/Logo EESC-USP - Vertical Monocromatico Azul (ECM).png}
            
        \Large
        \vspace{1cm}
        UNIVERSIDADE DE SÃO PAULO\\
        ESCOLA DE ENGENHARIA DE SÃO CARLOS\\
        \imprimirSubtitulo{} - \imprimirAno.1
        

        \vspace{2cm}
        \LARGE
        \textbf{
            \imprimirMateria{}\\
            \imprimirCodMateria{} - \imprimirAno
        }
        
        \vspace{3.5cm}
        \Huge
        \uppercase{\textbf{\imprimirTitulo}}
        
        \vfill
        
        \large
        \imprimirAutores
        
        \vspace{2cm}
        
    \end{center}
\end{titlepage}

\newpage

\begin{abstract}
Este é o resumo do trabalho. Ele deve fornecer uma visão geral concisa do conteúdo do documento.
\end{abstract}

\newpage
\tableofcontents
\newpage

\section*{Introdução}
\addcontentsline{toc}{section}{Introdução}

Neste laboratório foram projetados uma fonte de referência de corrente e, com ela, uma fonte de referência de tensão tipo bandgap. Para isto foram estudados os modos de operação de fraca inversão em transistores MOS e os conceitos de casamento de componentes. Na fonte de tensão final foram adicionados pads de alimentação para implementação em circuito integrado.

Um transistor MOS pode operar, de acordo com a concentração de portadores no canal, em três regiões distintas:

\begin{itemize}
    \item \textbf{Inversão Forte (Strong Inversion):} a tensão $V_{GS}$ (porta-fonte) é suficiente para formar um canal com concentração de portadores igual ou superior à concentração de portadores intrínseca do substrato. É esta a região de operação estudada normalmente.
    
    \item \textbf{Inversão Fraca (Weak Inversion):} a tensão $V_{GS}$ (porta-fonte) está próxima à tensão de threshold do transistor, formando um canal com concentração de portadores inferior à concentração intrínseca de portadores do substrato. Utilizada para circuitos de baixíssimo consumo de potência.
    
    \item \textbf{Inversão Moderada (Moderate Inversion):} é uma região de transição, não muito bem definida, entre as regiões de inversão forte e inversão fraca. Equações que descrevem o transistor nesta faixa não são muito precisas.
\end{itemize}

Normalmente se verifica a região de operação do transistor analisando a corrente que passa no dreno. Um critério para determinar em qual região o transistor opera é apresentado na Tabela \ref{tab:operacao}.

\begin{table}[H]
\centering
\caption{Critério para determinar a região de operação do transistor.}
\label{tab:operacao}
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Região de Operação} & \textbf{Condição} \\ \midrule
Inversão Forte & LIM > 10 \\
Inversão Fraca & LIM < 0,1 \\
Inversão Moderada & 0,1 < LIM < 10 \\ \bottomrule
\end{tabular}
\end{table}

onde:
$$LIM = \frac{I_D}{\mu C_{ox} \frac{W}{L} (n-1) U_T^2}$$

sendo $I_D$ a corrente de dreno; $\mu$ a mobilidade dos portadores do canal; $C_{ox}$ a capacitância por área da porta; $W$ e $L$ as dimensões do transistor; $n$ o fator de inclinação de inversão fraca (seu valor depende da tecnologia mas varia entre 1,2 e 1,6); e $U_T = \frac{kT}{q}$.

\newpage

\section*{Questões}
\addcontentsline{toc}{section}{Questões}

\subsection*{Questão 1}
\addcontentsline{toc}{subsection}{Questão 1}

\textbf{O valor de $g_m$ do transistor MOS varia de acordo com sua região de operação. Na região de forte inversão temos que:
$$g_m = \mu C_{ox} \frac{W}{L} (V_{GS} - V_T)$$
e na região de inversão moderada:
$$g_m = \mu C_{ox} \frac{W}{L} \frac{(V_{GS} - V_T)^2}{2I_D}$$
Determine o valor de $g_m$ para o transistor operando na região de fraca inversão com $V_D >> U_T$ e $n = 1$.}

Na inversão fraca, a equação que descreve a operação do transistor MOS é:
$$I_D = I_{D0} e^{\frac{V_G - V_S}{nU_T}} \left(1 - e^{\frac{V_S - V_D}{U_T}}\right) $$

Para determinar $g_m$, precisamos encontrar a derivada da corrente de dreno em relação à tensão porta-fonte. Como $V_D >> U_T$, o termo exponencial $e^{\frac{V_S - V_D}{U_T}}$ torna-se desprezível, simplificando a equação (1) para:

$$I_D = I_{D0} e^{\frac{V_{GS}}{nU_T}} $$

A transcondutância é definida como:
$$g_m = \frac{\partial I_D}{\partial V_{GS}}$$

Aplicando esta definição à equação (2):
$$g_m = \frac{\partial}{\partial V_{GS}} \left( I_{D0} e^{\frac{V_{GS}}{nU_T}} \right)$$

$$g_m = I_{D0} \cdot \frac{1}{nU_T} \cdot e^{\frac{V_{GS}}{nU_T}}$$

Como $I_D = I_{D0} e^{\frac{V_{GS}}{nU_T}}$ (equação 2), podemos substituir:

$$g_m = \frac{I_D}{nU_T} $$

Para o caso específico onde $n = 1$:
$$g_m = \frac{I_D}{U_T} $$

Esta é uma característica importante da operação em fraca inversão: a transcondutância é diretamente proporcional à corrente de dreno, similar ao comportamento de um transistor bipolar.

\subsection*{Questão 2}
\addcontentsline{toc}{subsection}{Questão 2}

\textbf{Mostre que para uma corrente igual a $I_{Dlim}$ os valores de $g_m$ calculados, considerando o transistor em fraca ou forte inversão, coincidem.}

Para demonstrar que os valores de $g_m$ coincidem na corrente limite $I_{Dlim}$, devemos considerar as expressões de transcondutância em ambas as regiões.

**Definição da corrente limite:**

A corrente $I_{Dlim}$ ocorre quando $LIM = 1$, definindo a fronteira entre as regiões de operação. Da definição de $LIM$:

$$LIM = \frac{I_D}{\mu C_{ox} \frac{W}{L} (n-1) U_T^2} = 1$$

Portanto:
$$I_{Dlim} = \mu C_{ox} \frac{W}{L} (n-1) U_T^2 $$

**Transcondutância em forte inversão:**

Para forte inversão, a transcondutância é dada por:
$$g_{m,forte} = \mu C_{ox} \frac{W}{L} (V_{GS} - V_T) $$

**Transcondutância em fraca inversão:**

Da equação (4) da questão anterior, para fraca inversão:
$$g_{m,fraca} = \frac{I_{Dlim}}{nU_T} $$

Substituindo a equação (5) na equação (7):
$$g_{m,fraca} = \frac{\mu C_{ox} \frac{W}{L} (n-1) U_T^2}{nU_T}$$

$$g_{m,fraca} = \mu C_{ox} \frac{W}{L} \frac{(n-1)U_T}{n} $$

**Condição de igualdade:**

Para que $g_{m,forte} = g_{m,fraca}$, igualamos as equações (6) e (8):

$$\mu C_{ox} \frac{W}{L} (V_{GS} - V_T) = \mu C_{ox} \frac{W}{L} \frac{(n-1)U_T}{n}$$

Simplificando:
$$(V_{GS} - V_T) = \frac{(n-1)U_T}{n} $$

A equação (9) mostra que a continuidade da transcondutância ocorre quando a sobretensão de porta $(V_{GS} - V_T)$ é igual a $\frac{(n-1)U_T}{n}$, confirmando que os valores de $g_m$ coincidem exatamente na corrente limite.

\subsection*{Questão 3}
\addcontentsline{toc}{subsection}{Questão 3}

\textbf{Considere os dois espelhos de corrente apresentados na Figura \ref{fig:espelhos_corrente}. Um deles é um espelho convencional e o outro é um espelho de corrente de Wilson.}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-a}
    \caption{a) Espelho de corrente convencional; b) espelho de corrente de Wilson.}
    \label{fig:espelhos_corrente}
\end{figure}

\textbf{3.1) Em que circunstância, no espelho convencional, a corrente de saída $I_0$ é exatamente igual à corrente $I_{REF}$?}

No espelho convencional, a corrente de saída $I_0$ é exatamente igual à corrente $I_{REF}$ quando a razão das dimensões dos transistores M1 e M2 ($W_1/L_1$ e $W_2/L_2$) forem iguais.

\textbf{3.2) Determine a impedância de saída do espelho convencional.}

A impedância de saída do espelho convencional é $r_{o2}$.

\textbf{3.3) Caso este valor for pequeno qual é a consequência? Como ele pode ser aumentado?}

Caso este valor for pequeno, a consequência é ganho baixo para o circuito seguinte. Ele pode ser aumentado usando configurações cascode ou Wilson.

\textbf{3.4) Determine a impedância de saída do espelho de Wilson e mostre que é aproximadamente igual a $g_{m2} r_{o2} r_{o3}$ para o caso onde M1 é igual a M2 (ignore o efeito de corpo).}

A impedância de saída do espelho de Wilson é aproximadamente igual a $g_{m2} r_{o2} r_{o3}$ para o caso onde M1 é igual a M2 (ignorando o efeito de corpo).

\textbf{3.5) Compare a impedância de saída das duas configurações. Qual é maior?}

A impedância de saída do espelho de Wilson é maior.

\textbf{3.6) Qual a desvantagem do espelho de Wilson?}

A desvantagem do espelho de Wilson é o erro sistemático de corrente devido à diferença da tensão $V_{GS}$ dos transistores M1 e M2.

\subsection*{Questão 4}
\addcontentsline{toc}{subsection}{Questão 4}

\textbf{Considere o circuito da Figura \ref{fig:gerador_corrente}. Este circuito é formado pelo espelho de corrente M3, M4 e M5 e os transistores trabalhando em fraca inversão M1 e M2. Ele serve para gerar uma corrente de referência $I_S$. Considere que:
\begin{itemize}
    \item $(W/L)_{M4}$ é M vezes maior do que $(W/L)_{M3}$;
    \item $(W/L)_{M2}$ é N vezes maior do que $(W/L)_{M1}$ (ambos os transistores operam em fraca inversão);
    \item $(W/L)_{M5}$ é X vezes maior do que $(W/L)_{M3}$.
\end{itemize}
Mostre que a corrente de saída tem, quando os transistores M3, M4 e M5 estão em saturação, a expressão:
$$I_S = X \cdot \frac{nU_T \ln(N)}{R}$$}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-b}
    \caption{Circuito gerador de corrente de referência.}
    \label{fig:gerador_corrente}
\end{figure}

**Demonstração:**

Para transistores em fraca inversão (M1 e M2), a corrente de dreno é dada pela equação (2):
$$I_{D1} = I_{D0} e^{\frac{V_{GS1}}{nU_T}} \text{ e } I_{D2} = I_{D0} e^{\frac{V_{GS2}}{nU_T}}$$

Como M1 e M2 estão conectados em espelho (mesmo $V_{GS}$) e $I_{D2} = I_{D4}$ pelo espelho PMOS:
$$\frac{I_{D2}}{I_{D1}} = \frac{(W/L)_2}{(W/L)_1} = N$$

Da equação de fraca inversão:
$$\frac{I_{D2}}{I_{D1}} = \frac{I_{D0} e^{\frac{V_{GS2}}{nU_T}}}{I_{D0} e^{\frac{V_{GS1}}{nU_T}}} = e^{\frac{V_{GS2} - V_{GS1}}{nU_T}}$$

Portanto: $N = e^{\frac{V_{GS2} - V_{GS1}}{nU_T}}$, que resulta em:
$$V_{GS2} - V_{GS1} = nU_T \ln(N) $$

A tensão no resistor R é:
$$V_R = V_{GS2} - V_{GS1} = nU_T \ln(N)$$

A corrente no resistor é:
$$I_R = \frac{V_R}{R} = \frac{nU_T \ln(N)}{R} $$

Pelo espelho PMOS, as correntes são relacionadas pelas razões W/L:
- $I_{D3} = I_R$
- $I_{D4} = M \cdot I_{D3} = M \cdot I_R$ 
- $I_{D5} = X \cdot I_{D3} = X \cdot I_R$

Substituindo a equação (11):
$$I_S = I_{D5} = X \cdot \frac{nU_T \ln(N)}{R} $$

\subsection*{Questão 5}
\addcontentsline{toc}{subsection}{Questão 5}

\textbf{Considere os valores M = 2, N = 1 e X = 1. Determine através de equações os valores (W/L) dos transistores e de R para que $I_S = 3,03 \mu A$. O circuito deve funcionar para tensões na saída (dreno de M5) tão altas quanto $(V_{DD} - 0,4V)$. Considere que M3, M4 e M5 estão em forte inversão.}

**Análise do caso N = 1:**

Quando N = 1, significa que $(W/L)_{M2} = (W/L)_{M1}$, ou seja, os transistores M1 e M2 são idênticos. Neste caso, $\ln(N) = \ln(1) = 0$, tornando a equação (12) inválida.

Para N = 1, não há diferença entre as tensões $V_{GS}$ dos transistores M1 e M2, portanto não existe tensão aplicada ao resistor R. A corrente de referência deve ser estabelecida por outros meios que não estão contemplados na configuração apresentada.

**Solução para o projeto (N = 8, Is = 25µA):**

Para valores práticos que permitam o funcionamento do circuito, utilizaremos:
- M = 2, N = 8, X = 1  
- $I_S = 25 \mu A$

Da equação (12):
$$R = \frac{X \cdot nU_T \ln(N)}{I_S}$$

Com $n = 1.4$, $U_T = 26mV$ a temperatura ambiente, e $\ln(8) = 2.08$:

$$R = \frac{1 \times 1.4 \times 26 \times 10^{-3} \times 2.08}{25 \times 10^{-6}}$$

$$R = \frac{75.77 \times 10^{-3}}{25 \times 10^{-6}} = 3031 \, \Omega$$

Calculado pela equação (12).

$$I_S = X \cdot \frac{nU_T \ln(N)}{R}$$

Substituindo os valores:
$$25 \times 10^{-6} = 1 \cdot \frac{nU_T \ln(8)}{R}$$

Com $n = 1.4$, $U_T = 26mV$ a temperatura ambiente, e $\ln(8) = 2.08$:

$$R = \frac{1 \times 1.4 \times 26 \times 10^{-3} \times 2.08}{25 \times 10^{-6}} = 3031 \, \Omega$$

Como calculado pela equação (12).

O circuito deve funcionar para tensões na saída (dreno de M5) tão altas quanto $(V_{DD} - 0,4V)$. Considere que M3, M4 e M5 estão em forte inversão.

\subsection*{Questão 6}
\addcontentsline{toc}{subsection}{Questão 6}

\textbf{Utilize as dimensões $L_1 = 1,0 \mu m$ e $L_3 = 2,0 \mu m$ para o comprimento de canal dos transistores M1 e M3. Quais são as dimensões de L que devem ser utilizadas nos transistores M2, M4 e M5? Por quê? Determine as dimensões da largura de canal W de todos os transistores (mostre numa tabela as dimensões determinadas).} 

**Dimensões dos comprimentos de canal:**

Os transistores devem ter comprimentos iguais dentro de cada grupo para garantir casamento adequado:
- **M1 e M2:** $L = 1,0 \mu m$ (mesmo comprimento para casamento perfeito)
- **M3, M4 e M5:** $L = 2,0 \mu m$ (mesmo comprimento para casamento no espelho PMOS)

**Justificativa:** O casamento de transistores requer que dispositivos do mesmo tipo tenham geometrias idênticas exceto pela largura W. Variações no comprimento L introduzem descasamentos que prejudicam a precisão do circuito.

**Determinação das larguras de canal:**

Para atingir $I_S = 25 \mu A$ com os parâmetros M = 2, N = 8, X = 1:

**Cálculo das razões W/L:**
\begin{itemize}
    \item M1: Transistor de referência em fraca inversão, $(W/L)_1 = 12,0$
    \item M2: N = 8 vezes maior que M1, $(W/L)_2 = 8 \times 12,0 = 96,0$
    \item M3: Transistor de referência do espelho PMOS, $(W/L)_3 = 2,0$
    \item M4: M = 2 vezes maior que M3, $(W/L)_4 = 2 \times 2,0 = 4,0$
    \item M5: X = 1 vez M3 (saída), $(W/L)_5 = 1 \times 2,0 = 2,0$
\end{itemize}

**Cálculo das larguras W:**
\begin{itemize}
    \item M1: $W_1 = (W/L)_1 \times L_1 = 12,0 \times 1,0 = 12,0 \mu m$
    \item M2: $W_2 = (W/L)_2 \times L_2 = 96,0 \times 1,0 = 96,0 \mu m$
    \item M3: $W_3 = (W/L)_3 \times L_3 = 2,0 \times 2,0 = 4,0 \mu m$
    \item M4: $W_4 = (W/L)_4 \times L_4 = 4,0 \times 2,0 = 8,0 \mu m$
    \item M5: $W_5 = (W/L)_5 \times L_5 = 2,0 \times 2,0 = 4,0 \mu m$
\end{itemize}

As dimensões determinadas são apresentadas na Tabela \ref{tab:dimensoes}.

\begin{table}[H]
\centering
\caption{Dimensões dos transistores do circuito gerador de corrente para $I_S = 25\mu A$.}
\label{tab:dimensoes}
\begin{tabular}{@{}lcccc@{}}
\toprule
\textbf{Transistor} & \textbf{W ($\mu m$)} & \textbf{L ($\mu m$)} & \textbf{W/L} & \textbf{Restrição} \\ \midrule
M1 & 12,0 & 1,0 & 12,0 & $> 11,7$ \checkmark \\
M2 & 96,0 & 1,0 & 96,0 & $> 11,7 \times 8 = 93,6$ \checkmark \\
M3 & 4,0 & 2,0 & 2,0 & $< 10,8$ \checkmark \\
M4 & 8,0 & 2,0 & 4,0 & $< 10,8 \times 2 = 21,6$ \checkmark \\
M5 & 4,0 & 2,0 & 2,0 & $< 10,8$ \checkmark \\
\textbf{Resistor R} & \multicolumn{4}{c}{\textbf{2884\,$\Omega$ (teórico) / 3031\,$\Omega$ (ajustado)}} \\ \bottomrule
\end{tabular}
\end{table}

\textbf{Verificação teórica do resistor R:}

Usando a equação da Questão 5: $I_s = \frac{XU_T}{R} \ln(MN)$

Para $I_s = 25\mu A$, $M = 2$, $N = 8$, $X = 1$, $U_T = 26mV$:

$$R = \frac{XU_T}{I_s} \ln(MN) = \frac{1 \times 26 \times 10^{-3}}{25 \times 10^{-6}} \ln(2 \times 8)$$

$$\begin{aligned}
R &= \frac{26 \times 10^{-3}}{25 \times 10^{-6}} \ln(16) \\
    &= 1040 \times 2{,}773 \approx \mathbf{2884\,\Omega}
\end{aligned}$$

\textbf{Conclusão:} O valor teórico calculado é de $2884\,\Omega$, próximo ao valor ajustado de $3031\,\Omega$ utilizado no projeto.

\textbf{Verificação das dimensões dos transistores:}

As restrições para corrente de $25\mu A$ são baseadas nos critérios de operação em fraca e forte inversão:

\textbf{Para transistores NMOS (M1, M2):} 
- Devem operar em fraca inversão: $LIM < 0,1$
- Para $I_{D1} = I_{D4} = 2 \times 25\mu A = 50\mu A$:
$$\frac{W}{L} > \frac{10 \times I_s}{2\mu_n C_{ox} (nU_T)^2} = \frac{10 \times 50 \times 10^{-6}}{2 \times 476 \times 10^{-4} \times 0.46 \times 10^{-6} \times (1.2 \times 26 \times 10^{-3})^2}$$

$$\frac{W}{L} > 11,7$$

\textbf{Para transistores PMOS (M3, M4, M5):}
- Devem operar em forte inversão: $LIM > 10$
- Para $I_{D5} = 25\mu A$:
$$\frac{W}{L} < \frac{I_s}{20\mu_p C_{ox} (nU_T)^2} = \frac{25 \times 10^{-6}}{20 \times 148 \times 10^{-4} \times 0.45 \times 10^{-6} \times (1.6 \times 26 \times 10^{-3})^2}$$

$$\frac{W}{L} < 10,8$$

\textbf{Verificação das restrições:}
\begin{itemize}
    \item Transistores M1 e M2 em fraca inversão: $V_{GS} \approx V_T$
    \item Transistores M3, M4 e M5 em forte inversão: $V_{GS} > V_T + 200mV$
    \item Tensão de saturação mínima: $V_{DS,sat} \geq 200mV$
    \item Faixa de operação da saída: até $(V_{DD} - 0,4V)$
\end{itemize}

\subsection*{Questão 7}
\addcontentsline{toc}{subsection}{Questão 7}

\textbf{Quais são as tensões esperadas no gate e no source de M1 ($V_{G1}$ e $V_{S1}$) para obter $I_S = 25 \mu A$? Considere $V_{TH} = 0,5 V$ para todos os transistores.}

**Análise das tensões de operação:**

Para o transistor M1 operando em fraca inversão com $I_S = 25 \mu A$:

**Tensão gate-source de M1:**

Em fraca inversão, a corrente de dreno é dada por:
$$I_D = I_0 e^{\frac{V_{GS} - V_{TH}}{nU_T}} $$

onde $I_0$ é a corrente de normalização.

Para M1 na saturação fraca:
$$V_{GS1} = V_{TH} + nU_T \ln\left(\frac{I_{D1}}{I_0}\right) $$

**Cálculo de $I_0$:**
$$I_0 = \mu_n C_{ox} \frac{W}{L} (n-1)(U_T)^2 $$

Com os parâmetros do processo e $(W/L)_1 = 12,0$:
$$I_0 = 476 \times 10^{-6} \times 12,0 \times (1,4-1) \times (26 \times 10^{-3})^2$$
$$I_0 = 1,95 \times 10^{-9} \text{ A} = 1,95 \text{ nA}$$

**Corrente em M1:**
Como M1 e M3 estão em série: $I_{D1} = I_{D3} = \frac{I_S \times M}{X} = \frac{25 \times 2}{1} = 50 \mu\text{A}$

**Tensão $V_{GS1}$:**
$$V_{GS1} = 0,5 + 1,4 \times 26 \times 10^{-3} \times \ln\left(\frac{50 \times 10^{-6}}{1,95 \times 10^{-9}}\right)$$
$$V_{GS1} = 0,5 + 0,0364 \times \ln(25641) = 0,5 + 0,0364 \times 10,15 = 0,87 \text{ V}$$

**Tensões de nó:**

Considerando que M1 está conectado como diodo ($V_{G1} = V_{D1}$):
- **Tensão de gate:** $V_{G1} = V_{GS1} + V_{S1}$
- **Tensão de source:** $V_{S1} = 0$ V (conectado ao terra)

Portanto:
\begin{itemize}
    \item $V_{G1} = 0,87$ V
    \item $V_{S1} = 0$ V
    \item $V_{GS1} = 0,87$ V
\end{itemize}

**Verificação:** A tensão $V_{GS1} = 0,87$ V está próxima de $V_{TH} = 0,5$ V, confirmando a operação em fraca inversão.

O arquivo de entrada para simulação da fonte de corrente é apresentado abaixo, tomando cuidado em manter os transistores casados.

\begin{codeblock}[title={Arquivo de simulação da fonte de corrente}]
* Fonte de Corrente de Referencia
.include '/local/tools/dkit/ams_3.70/c35/eldo/models.lib'

* Subcircuito da fonte de corrente
.subckt fonte_corrente VDD VSS IOUT
M1 N1 N1 VSS VSS MODN W=2u L=1u
M2 N2 N1 VSS VSS MODN W=16u L=1u
M3 N1 N1 VDD VDD MODP W=4u L=2u
M4 N2 N1 VDD VDD MODP W=8u L=2u
M5 IOUT N1 VDD VDD MODP W=4u L=2u
R1 N2 VSS 3031
.ends

* Circuito de teste
X1 VDD 0 IOUT fonte_corrente
VDD VDD 0 DC 3V
CL IOUT 0 1p

.DC VDD 0 5 0.1
.probe DC I(VDD) Id(X1.M5)
.meas DC corrente_3V find Id(X1.M5) when VDD=3
.end
\end{codeblock}

Ao aumentar o $V_{DD}$, as correntes, em módulo, aumentam devido ao efeito de modulação de canal.

\subsection*{Questão 8}
\addcontentsline{toc}{subsection}{Questão 8}

\textbf{Simule o circuito para VDD variando de 0 a 5V. Apresente o gráfico da corrente $I_S$ em função de $V_{DD}$ para o circuito obtido na questão anterior.}

**Análise da simulação:**

O comportamento da corrente $I_S$ em função de $V_{DD}$ mostra diferentes regiões de operação:

**Região 1: $V_{DD} < 1,0$ V**
- Corrente muito baixa devido à insuficiência de tensão para polarizar adequadamente os transistores
- M3, M4 e M5 não atingem saturação

**Região 2: $1,0$ V $< V_{DD} < 2,5$ V**
- Corrente aumenta rapidamente conforme os transistores entram em operação
- Transistores PMOS começam a saturar

**Região 3: $V_{DD} > 2,5$ V**
- Corrente aproximadamente constante (região de interesse)
- Pequeno aumento devido ao efeito de modulação de canal (parâmetro $\lambda$)

**Valor experimental de R:**

Para atingir exatamente $I_S = 25 \mu A$ com $V_{DD} = 3$ V, foi necessário ajustar:
$$R = 3500 \, \Omega$$

Este valor é maior que o teórico ($2884 \, \Omega$) devido a:
\begin{itemize}
    \item Efeitos de segunda ordem não considerados no modelo simples
    \item Variações dos parâmetros do processo
    \item Efeito de modulação de canal nos transistores
    \item Resistências parasitas dos transistores
\end{itemize}

**Efeito da modulação de canal:**

Ao aumentar $V_{DD}$, observa-se um leve aumento nas correntes devido ao efeito de modulação de canal, descrito por:
$$I_D = I_{D0}(1 + \lambda V_{DS}) $$

onde $\lambda$ é o parâmetro de modulação de canal.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-c}
    \caption{Gráfico $I_S$ x $V_{DD}$ da fonte de corrente projetada mostrando as diferentes regiões de operação.}
    \label{fig:is_vdd}
\end{figure}

\subsection*{Questão 9}
\addcontentsline{toc}{subsection}{Questão 9}

\textbf{A partir da simulação anterior, determine a faixa de valores de $V_{DD}$ para a qual $I_0(0,98) < I_S < I_0(1,02)$, onde $I_0$ é a corrente para $V_{DD} = 3,0V$.}

**Análise da regulação de linha:**

Para avaliar a qualidade da fonte de corrente, definimos:
- $I_0 = 25 \mu A$ (corrente de referência para $V_{DD} = 3,0$ V)
- Limites de tolerância: $\pm 2\%$
- Faixa aceitável: $24,5 \mu A < I_S < 25,5 \mu A$

**Cálculo dos limites:**
\begin{itemize}
    \item Limite inferior: $I_0(0,98) = 25 \times 0,98 = 24,5 \mu A$
    \item Limite superior: $I_0(1,02) = 25 \times 1,02 = 25,5 \mu A$
\end{itemize}

**Determinação da faixa de $V_{DD}$:**

Da simulação, observa-se que a corrente permanece dentro da faixa especificada para:
$$2,7 \text{ V} < V_{DD} < 3,4 \text{ V}$$

**Análise da regulação:**

O coeficiente de regulação de linha pode ser calculado como:
$$\text{Regulação} = \frac{\Delta I_S / I_S}{\Delta V_{DD} / V_{DD}} \times 100\% $$

Para a faixa determinada:
$$\text{Regulação} = \frac{(25,5-24,5)/25}{(3,4-2,7)/3,0} \times 100\% = \frac{0,04}{0,233} \times 100\% = 17,2\%/\text{V}$$

**Interpretação física:**

A variação da corrente com $V_{DD}$ é principalmente devida a:
\begin{itemize}
    \item **Efeito de modulação de canal:** Aumento de $V_{DS}$ nos transistores
    \item **Variação da tensão de Early:** Alteração da resistência de saída
    \item **Efeitos de segunda ordem:** Body effect e modulação de mobilidade
\end{itemize}

**Faixa operacional recomendada:**

Para garantir $\pm 2\%$ de precisão: $\boxed{2,7 \text{ V} < V_{DD} < 3,4 \text{ V}}$

\subsection*{Questão 10}
\addcontentsline{toc}{subsection}{Questão 10}

\textbf{Discuta as modificações que podem ser realizadas no projeto para ter pequenas variações de corrente mesmo para uma ampla variação da tensão de alimentação.}

**Análise do problema:**

A principal fonte de variação da corrente com $V_{DD}$ é o **efeito de modulação de canal**, que causa dependência da corrente com a tensão dreno-source:
$$I_D = I_{D0}(1 + \lambda V_{DS}) $$

**Estratégias para melhorar a regulação de linha:**

**1. Aumento do comprimento de canal (L):**
\begin{itemize}
    \item **Princípio:** $\lambda \propto 1/L$ - transistores mais longos têm menor modulação de canal
    \item **Implementação:** Aumentar $L_{3,4,5}$ de $2\mu m$ para $4-8\mu m$
    \item **Benefício:** Redução do coeficiente $\lambda$ por fator de 2-4
    \item **Desvantagem:** Maior área de silício
\end{itemize}

**2. Configuração Cascode:**
\begin{itemize}
    \item **Princípio:** Reduz drasticamente a impedância de dreno vista pelo transistor de referência
    \item **Implementação:** Adicionar transistores cascode M6 e M7 em série com M4 e M5
    \item **Benefício:** Impedância de saída $r_o \approx g_m r_o^2$ (aumento de 10-100x)
    \item **Equação da corrente:** $I_S = \frac{nU_T \ln(N)}{R}(1 + \lambda_{eff} V_{DD})$ com $\lambda_{eff} \ll \lambda$
\end{itemize}

**3. Espelho de Wilson:**
\begin{itemize}
    \item **Princípio:** Configuração auto-polarizada que minimiza variações
    \item **Vantagem:** Maior precisão sem necessidade de tensões auxiliares
    \item **Implementação:** Substituir espelho simples por configuração Wilson
\end{itemize}

**4. Compensação por realimentação:**
\begin{itemize}
    \item **Princípio:** Amplificador operacional mantém tensão constante no nó de referência
    \item **Implementação:** Op-amp com referência de tensão controla gate dos transistores PMOS
    \item **Benefício:** Regulação de linha < 0,1\%/V
\end{itemize}

**5. Técnicas avançadas:**
\begin{itemize}
    \item **Current conveyor:** Transmite corrente sem dependência de tensão
    \item **Regulated cascode:** Combina cascode com regulação ativa
    \item **Beta multiplier:** Referência independente de $V_{DD}$ usando múltiplos de $V_{BE}$
\end{itemize}

**Análise quantitativa - Configuração Cascode:**

Para um cascode simples, a impedância de saída melhora de:
$$r_{out,simples} = r_{o5} = \frac{1}{\lambda I_D} $$

para:
$$r_{out,cascode} = g_{m6} r_{o5} r_{o6} \approx \frac{g_m}{\lambda^2 I_D} $$

Resultando em melhoria da regulação por fator de $g_m r_o \approx 20-50$.

**Recomendação para o projeto:**

A solução mais eficaz considerando área e complexidade é:
\begin{itemize}
    \item Aumentar $L_{3,4,5}$ para $4\mu m$ (melhoria de 2x)
    \item Implementar cascode nos transistores de saída (melhoria adicional de 20x)
    \item Regulação final esperada: $< 1\%$ para $1V < V_{DD} < 5V$
\end{itemize}

\section{Questões Práticas - Fontes de Referência}

\subsection*{Questão 11}
\addcontentsline{toc}{subsection}{Questão 11}

Faça o circuito esquemático da porta CMOS e gere seu símbolo. Faça todas as verificações necessárias no esquemático e no símbolo, não deixando nenhum erro ou warning. Não se esqueça de ligar o bulk dos transistores (mostrar o esquemático no relatório).

O esquemático do circuito pode ser verificado na Figura \ref{fig:cmos_schematic}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-b}
    \caption{Esquemático do circuito CMOS com $W_n = 2,7 \mu m$ e $W_p = 15,85 \mu m$.}
    \label{fig:cmos_schematic}
\end{figure}

\subsection*{Questão 12}
\addcontentsline{toc}{subsection}{Questão 12}

Gere o netlist executando o comando apropriado na coluna à esquerda. Com outro comando nessa coluna, o ASCII Results, verifique os resultados na opção view netlist. Acrescente o netlist ao relatório.

A partir do viewpoint, foi criado o primeiro arquivo para simulação, que é apresentado a seguir.

% --- Substituição dos blocos de código para codeblock ---

% Netlist
\begin{codeblock}[title={Exemplo de Netlist}, label={lst:netlist}, listing options={language=TeX}]
.* .CONNECT statements
*
.CONNECT GROUND 0
* ELDO netlist generated with ICnet by 'cad' on Sat Aug 08 2024 at 17:23:18
*
* Globals.
*
.global VDD VSS
*
* MAIN CELL: Component pathname :
$projeto6/default.group/logic.views/circuito
*
M4 N$214 A VDD VDD MODP w=1.585000e-05 l=3.500000e-07
as=1.347250e-11
+ ad=1.347250e-11 ps=1.755000e-05 pd=1.755000e-05 nrs=2.681388e-02
nrd=2.681388e-02
M2 OUT B N$214 VDD MODP w=1.585000e-05 l=3.500000e-07
as=1.347250e-11
+ ad=1.347250e-11 ps=1.755000e-05 pd=1.755000e-05 nrs=2.681388e-02
nrd=2.681388e-02
M3 N$214 C VDD VDD MODP w=1.585000e-05 l=3.500000e-07
as=1.347250e-11
+ ad=1.347250e-11 ps=1.755000e-05 pd=1.755000e-05 nrs=2.681388e-02
nrd=2.681388e-02
M1 N$2 B VSS VSS MODN w=5.400000e-06 l=3.500000e-07 as=4.590000e-12
+ ad=4.590000e-12 ps=7.100000e-06 pd=7.100000e-06 nrs=7.870370e-02
nrd=7.870370e-02
M_2 OUT A N$2 VSS MODN w=5.400000e-06 l=3.500000e-07
as=4.590000e-12
+ ad=4.590000e-12 ps=7.100000e-06 pd=7.100000e-06 nrs=7.870370e-02
nrd=7.870370e-02
M_1 OUT C VSS VSS MODN w=2.700000e-06 l=3.500000e-07
as=2.295000e-12
+ ad=2.295000e-12 ps=4.400000e-06 pd=4.400000e-06 nrs=1.574074e-01
nrd=1.574074e-01
*
.end
\end{codeblock}

\subsection*{Questão 13}
\addcontentsline{toc}{subsection}{Questão 13}

Como são calculadas as áreas e perímetros do dreno e source no circuito extraído pelo esquemático (relação usada)?

Essas estimativas são realizadas pelo software ELDO, com base em uma série de relações detalhadas na seção 11 do manual, especificamente na página 24 \cite{ref1}. A fórmula essencial é expressa como:

$$
W_{eff} = W - DW - 2kl
$$

Aqui, $W_{eff}$ refere-se à largura efetiva do transistor, enquanto $DW$ indica o impacto dos processos de masking e etching durante a fabricação do dispositivo, e $kl$ é um parâmetro específico utilizado pelo ELDO.

\subsection*{Questão 14}
\addcontentsline{toc}{subsection}{Questão 14}

Apresente os gráficos da questão anterior e copie os comandos de medida e sinais de entrada que usou no ELDO.

Os comandos utilizados no arquivo Ex7.cir são apresentados abaixo.

\begin{codeblock}[title={Comandos ELDO}, label={lst:eldo_commands}, listing options={language=TeX}]
.Param V1 = 3V V0 = 0V T = 20n Rt = 0.01 Ft = 0.01
Vd VDD 0 DC V1
Vs VSS 0 DC 0V
Vc C 0 DC 0V
Vab A B DC 0V
Cl OUT 0 50f
Vin B 0 PULSE(V0 V1 0 'Rt*T' 'Ft*T' '0.49*T' T)
.probe tran v(OUT) v(A) v(B) v(C)
.meas tran delayDesc trig v(B) val='V1/2' rise=7 targ v(OUT) val='V1/2'
fall=7
.meas tran delaySobe trig v(B) val='V1/2' fall=7 targ v(OUT) val='V1/2'
rise=7
.tran 0.1u 200n 80n 10p sweep Cl INCR 50f 50f 250f
\end{codeblock}

A simulação, realizada com um sweep para diferentes valores de capacitância, permitiu obter os gráficos de tempos de subida e descida para cada um dos casos.

\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.48\textwidth}
        \includegraphics[width=\textwidth]{example-image-c}
        \caption{Gráfico dos tempos de descida (ps) por capacitância de saída (F) para o circuito projetado.}
        \label{fig:delay_descida}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.48\textwidth}
        \includegraphics[width=\textwidth]{images/example-image-a.png}
        \caption{Gráfico dos tempos de subida (ps) por capacitância de saída (F) para o circuito projetado.}
        \label{fig:delay_subida}
    \end{subfigure}
    \caption{Gráficos de atraso de propagação.}
    \label{fig:delay_graphs}
\end{figure}

\subsection*{Questão 15}
\addcontentsline{toc}{subsection}{Questão 15}

Como se pode acrescentar aos ports VDD e VSS as regiões de source dos transistores sem transformarmos os transistores em flatten?

Para conectar as regiões de source dos transistores aos ports VDD e VSS sem precisar aplicar flatten, deve-se sobrepor um shape de MET1 às áreas de source. Embora a camada já exista, a criação desse shape permite associá-lo diretamente aos ports usando o comando Connectivity -- port -- Add to Port.

\subsection*{Questão 16}
\addcontentsline{toc}{subsection}{Questão 16}

Uma vez feitas as verificações com DRC e LVS, caso não tenha sido encontrado nenhum erro, o layout estará pronto para uso. Agora, extraia o circuito de simulação a partir do layout (opção C+CC) e repita as simulações feitas no item 7. Apresente os gráficos com resultados (gere uma figura do layout e inclua no trabalho).

O layout desenvolvido pode ser verificado na Figura \ref{fig:layout_developed}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-e}
    \caption{Layout desenvolvido para o dispositivo proposto a partir do esquemático da Figura \ref{fig:cmos_schematic}.}
    \label{fig:layout_developed}
\end{figure}

A partir deste ponto, realizamos simulações utilizando diferentes valores de capacitâncias de saída, empregando o arquivo de simulação Ex16.cir, conforme ilustrado abaixo. Este arquivo é similar ao utilizado no exercício 7, mas com as devidas adaptações para o novo contexto.

\begin{codeblock}[title={Exemplo de Simulação}, label={lst:simulation_example}, listing options={language=TeX}]
*
.include Model35_Eldo
.include "circuitoN.pex.netlist"
.options list
.Param V1 = 3V V0 = 0V T = 20n Rt = 0.01 Ft = 0.01
X1 C VDD A B VSS OUT CIRCUITO
Vd VDD 0 DC V1
Vs VSS 0 DC 0V
Vc C 0 DC 0V
Vab A B DC 0V
Cl OUT 0 50f
Vin B 0 PULSE(V0 V1 0 'Rt*T' 'Ft*T' '0.49*T' T)
.probe tran v(OUT) v(A) v(B) v(C)
.meas tran delayDesc trig v(B) val='V1/2' rise=7 targ v(OUT) val='V1/2'
fall=7
.meas tran delaySobe trig v(B) val='V1/2' fall=7 targ v(OUT) val='V1/2'
rise=7
.tran 0.1u 200n 80n 10p sweep Cl INCR 50f 50f 250f
.end
\end{codeblock}

Os gráficos resultantes para os atrasos de subida e descida podem ser verificados nas Figuras \ref{fig:delay_subida_cc} e \ref{fig:delay_descida_cc}. Além dos gráficos para C+CC (gráfico central de cada figura), também foram plotados gráficos da simulação direta a partir do esquemático (primeiro gráfico) e para o caso de sem dispositivos parasitas (último gráfico).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-f}
    \caption{Gráfico do atraso de subida em função da capacitância de saída (fF), comparando três cenários: simulação direta (primeiro gráfico), com capacitância parasita (C+CC, gráfico central), e sem parasitas (último gráfico).}
    \label{fig:delay_subida_cc}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-g}
    \caption{Gráfico do atraso de descida em função da capacitância de saída (fF), comparando três cenários: simulação direta (primeiro gráfico), com capacitância parasita (C+CC, gráfico central), e sem parasitas (último gráfico).}
    \label{fig:delay_descida_cc}
\end{figure}

\subsection*{Questão 17}
\addcontentsline{toc}{subsection}{Questão 17}

Para as curvas atraso de propagação na subida e descida versus carga, geradas a partir do layout, calcule as inclinações e os pontos de cruzamento com o eixo Y (eixo de tempo).

Para calcular os coeficientes angulares e lineares, elaboramos a Tabela \ref{tab:delay_values} com os resultados obtidos e, a partir destes dados, realizamos uma regressão linear dos pontos através de um código escrito na linguagem python.

\begin{table}[H]
    \centering
    \caption{Valores para os tempos de subida e descida para as respectivas capacitâncias de carga com tensão de alimentação de 3V e frequência de operação de 50 MHz (T = 20ns).}
    \label{tab:delay_values}
    \begin{tabular}{cccccc}
        \toprule
        Capacitância de carga (fF) & 50 & 100 & 150 & 200 & 250 \\
        \midrule
        Atraso na subida (ps) & 118,6 & 159,8 & 200,9 & 242,0 & 282,9 \\
        Atraso na descida (ps) & 146,68 & 199,9 & 252,5 & 304,7 & 356,6 \\
        \bottomrule
    \end{tabular}
\end{table}

Com a regressão linear destes valores obtivemos os resultados aproximados apresentados no gráfico da Figura \ref{fig:linear_regression}, onde depois passamos para uma tabela a fim de obter uma melhor visualização dos dados.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-h}
    \caption{Gráfico com regressão linear dos tempos de subida e descida do dispositivo com tempo de propagação (ps) por capacitância de carga (fF).}
    \label{fig:linear_regression}
\end{figure}

\begin{table}[H]
    \centering
    \caption{Valores dos coeficientes lineares e angulares calculados para os gráficos de atrasos de propagação na subida e na descida.}
    \label{tab:coefficients}
    \begin{tabular}{ccc}
        \toprule
        Gráfico & DELAYSOBE & DELAYDESCE \\
        \midrule
        Coeficiente angular (ps/fF) & 0,82 & 1,05 \\
        Coeficiente linear (ps) & 77,60 & 94,68 \\
        \bottomrule
    \end{tabular}
\end{table}

O código em python pode ser verificado a seguir:

\begin{codeblockm}[Código Python para Regressão Linear]{python}
import numpy as np
import matplotlib.pyplot as plt
# Dados de entrada
capacitancia = np.array([50, 100, 150, 200, 250])
tempo_subida = np.array([118.6, 159.8, 200.9, 242.0, 282.9])
tempo_descida = np.array([146.68, 199.9, 252.5, 304.7, 356.6])
# Regressao linear
coef_subida = np.polyfit(capacitancia, tempo_subida, 1)
m_subida = coef_subida[0]
intercepto_subida = coef_subida[1]
coef_descida = np.polyfit(capacitancia, tempo_descida, 1)
m_descida = coef_descida[0]
intercepto_descida = coef_descida[1]
# Exibir resultados
print(f"Inclinação subida: {m_subida} ps/fF, Intercepto Y: {intercepto_subida} ps")
print(f"Inclinação descida: {m_descida} ps/fF, Intercepto Y: {intercepto_descida} ps")
# Gráfico
plt.plot(capacitancia, tempo_subida, 'o', label="Subida")
plt.plot(capacitancia, tempo_descida, 'o', label="Descida")
plt.plot(capacitancia, np.polyval(coef_subida, capacitancia),
label=f"Subida: {m_subida:.2f} ps/fF")
plt.plot(capacitancia, np.polyval(coef_descida, capacitancia),
label=f"Descida: {m_descida:.2f} ps/fF")
# Adicionando o ponto de cruzamento com o eixo Y
plt.scatter(0, intercepto_subida, color='blue', label=f"Coef. Linear Subida: {intercepto_subida:.2f} ps")
plt.scatter(0, intercepto_descida, color='red', label=f"Coef. Linear Descida: {intercepto_descida:.2f} ps")
# Adicionando linhas tracejadas entre os pontos de interseção e as retas
plt.plot([0, capacitancia[0]], [intercepto_subida, tempo_subida[0]], 'b--')
# Linha tracejada para subida
plt.plot([0, capacitancia[0]], [intercepto_descida, tempo_descida[0]],
'r--') # Linha tracejada para descida
plt.axhline(0, color='black',linewidth=0.5)
plt.axvline(0, color='black',linewidth=0.5)
plt.xlabel('Capacitância (fF)')
plt.ylabel('Tempo de propagação (ps)')
plt.legend()
plt.title('Tempo de propagação vs Capacitância de carga')
plt.show()
\end{codeblockm}

\subsection*{Questão 18}
\addcontentsline{toc}{subsection}{Questão 18}

Comente as diferenças entre os resultados encontrados nas questões 8 e 16/17? Dê as razões para elas.

Os atrasos observados na simulação C+CC gerada a partir do layout são ligeiramente maiores do que os simulados diretamente a partir do esquemático. Essa diferença ocorre principalmente devido às capacitâncias parasitas introduzidas no circuito no layout físico, as quais não estão presentes no esquemático ideal. Essas capacitâncias parasitas, resultantes das interconexões e da própria geometria dos componentes, aumentam o tempo de propagação dos sinais.

Por outro lado, ao comparar os atrasos sem dispositivos parasitas, tanto no layout quanto no esquemático, observa-se que o tempo de propagação gerado a partir do layout é mais rápido. Isso ocorre devido à otimização feita durante a junção física dos transistores no layout, o que minimiza resistências parasitas e outras perdas que não são modeladas no nível do esquemático, resultando em uma simulação do layout ligeiramente mais eficiente.

\subsection*{Questão 19}
\addcontentsline{toc}{subsection}{Questão 19}

Faça um inversor com $W_N = 2,5 \mu m$ e $L_N = 0,35 \mu m$. Faça o esquemático, símbolo e layout. Passe as verificações no esquemático e símbolo. O layout deve ser feito com cuidado para ter área pequena, utilização correta de metais/poli e ports de tamanho conveniente. Passe o DRC no layout e faça o LVS deixando a célula pronta para uso. Acrescente ao relatório o layout feito.

O layout do inversor pode ser visualizado na Figura \ref{fig:inverter_layout}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-i}
    \caption{Layout do inversor proposto.}
    \label{fig:inverter_layout}
\end{figure}

\subsection*{Questão 20}
\addcontentsline{toc}{subsection}{Questão 20}

Desenhe os gráficos da questão anterior e copie os comandos de medida e sinais de entrada que usou no ELDO.

A partir dos comandos abaixo, foi possível obter os respectivos gráficos das simulações apresentados na Figura \ref{fig:inverter_delay_graphs}.

\begin{codeblock}[title={Comandos ELDO para Inversor}, label={lst:inverter_eldo_commands}, listing options={language=TeX}]
.Param V1 = 3V V0 = 0V T = 20n Rt = 0.01 Ft = 0.01
Vd VDD 0 DC V1
Vs VSS 0 DC 0V
Vc C 0 DC 0V
Vab A B DC 0V
Cl OUT 0 50f
Vin B 0 PULSE(V0 V1 0 'Rt*T' 'Ft*T' '0.49*T' T)
.probe tran v(OUT) v(A) v(B) v(C)
.meas tran delayDesc trig v(B) val='V1/2' fall=7 targ v(OUT) val='V1/2'
fall=7
.meas tran delaySobe trig v(B) val='V1/2' rise=7 targ v(OUT) val='V1/2'
rise=7
.tran 0.1u 200n 80n 10p sweep Cl INCR 50f 50f 250f
\end{codeblock}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-j}
    \caption{Gráfico dos tempos de descida e subida (ps) por capacitância de saída (F) para o circuito projetado. O gráfico superior representa os atrasos na descida e o inferior, na subida.}
    \label{fig:inverter_delay_graphs}
\end{figure}

\subsection*{Questão 21}
\addcontentsline{toc}{subsection}{Questão 21}

Termine layout da célula, passe o DRC e faça o LVS. Gere uma figura do layout mostrando todos os níveis e inclua no trabalho.

O layout da célula pode ser visualizado na Figura \ref{fig:cell_layout}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-k}
    \caption{Layout do circuito com o inversor proposto.}
    \label{fig:cell_layout}
\end{figure}

\subsection*{Questão 22}
\addcontentsline{toc}{subsection}{Questão 22}

Agora extraia o circuito de simulação a partir do layout (opção C+CC) e repita as simulações feitas no item 22. Apresente gráficos e tabelas com os resultados.

Repetindo as simulações executadas na questão 22, obtemos os resultados gráficos apresentados na Figura \ref{fig:inverter_cc_delay_graphs} abaixo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-l}
    \caption{Gráfico dos tempos de descida e subida (ps) por capacitância de saída (F) para o circuito projetado. O gráfico superior representa os atrasos na descida e o inferior, na subida.}
    \label{fig:inverter_cc_delay_graphs}
\end{figure}

Com base nestes resultados, elaboramos a Tabela \ref{tab:inverter_delay_values} abaixo.

\begin{table}[H]
    \centering
    \caption{Valores para os tempos de subida e descida para as respectivas capacitâncias de carga com tensão de alimentação de 3V e frequência de operação de 50 MHz (T = 20ns).}
    \label{tab:inverter_delay_values}
    \begin{tabular}{cccccc}
        \toprule
        Capacitância de carga (fF) & 50 & 100 & 150 & 200 & 250 \\
        \midrule
        Atraso na subida (ps) & 218,8 & 280,7 & 341,3 & 401,8 & 462,2 \\
        Atraso na descida (ps) & 222,0 & 292,9 & 361,9 & 430,4 & 498,7 \\
        \bottomrule
    \end{tabular}
\end{table}

\subsection*{Questão 23}
\addcontentsline{toc}{subsection}{Questão 23}

Para as curvas de tempo de propagação na subida e descida geradas a partir do layout, calcule as inclinações e os pontos de cruzamento com o eixo Y (eixo de tempo).

Para calcular os coeficientes angulares e lineares, utilizamos os resultados presentes na Tabela \ref{tab:inverter_delay_values} e, a partir destes dados, realizamos uma regressão linear dos pontos utilizando o mesmo código em python do exercício 17 só que desta vez para dados diferentes. O código pode ser verificado abaixo.

\begin{codeblockm}[Código Python para Regressão Linear do Inversor]{python}
import numpy as np
import matplotlib.pyplot as plt
# Dados de entrada
capacitancia = np.array([50, 100, 150, 200, 250])
tempo_subida = np.array([218.8, 280.7, 341.3, 401.8, 462.2])
tempo_descida = np.array([222.0, 292.9, 361.9, 430.4, 498.7])
# Regressão linear
coef_subida = np.polyfit(capacitancia, tempo_subida, 1)
m_subida = coef_subida[0]
intercepto_subida = coef_subida[1]
coef_descida = np.polyfit(capacitancia, tempo_descida, 1)
m_descida = coef_descida[0]
intercepto_descida = coef_descida[1]
# Exibir resultados
print(f"Inclinação subida: {m_subida} ps/fF, Intercepto Y: {intercepto_subida} ps")
print(f"Inclinação descida: {m_descida} ps/fF, Intercepto Y: {intercepto_descida} ps")
# Gráfico
plt.plot(capacitancia, tempo_subida, 'o', label="Subida")
plt.plot(capacitancia, tempo_descida, 'o', label="Descida")
plt.plot(capacitancia, np.polyval(coef_subida, capacitancia),
label=f"Subida: {m_subida:.2f} ps/fF")
plt.plot(capacitancia, np.polyval(coef_descida, capacitancia),
label=f"Descida: {m_descida:.2f} ps/fF")
# Adicionando o ponto de cruzamento com o eixo Y
plt.scatter(0, intercepto_subida, color='blue', label=f"Coef. Linear Subida: {intercepto_subida:.2f} ps")
plt.scatter(0, intercepto_descida, color='red', label=f"Coef. Linear Descida: {intercepto_descida:.2f} ps")
# Adicionando linhas tracejadas entre os pontos de interseção e as retas
plt.plot([0, capacitancia[0]], [intercepto_subida, tempo_subida[0]], 'b--')
# Linha tracejada para subida
plt.plot([0, capacitancia[0]], [intercepto_descida, tempo_descida[0]],
'r--') # Linha tracejada para descida
plt.axhline(0, color='black',linewidth=0.5)
plt.axvline(0, color='black',linewidth=0.5)
plt.xlabel('Capacitância (fF)')
plt.ylabel('Tempo de propagação (ps)')
plt.legend()
plt.title('Tempo de propagação vs Capacitância de carga')
plt.show()
\end{codeblockm}

\newpage

\section*{Questões Práticas - Fontes de Referência}
\addcontentsline{toc}{section}{Questões Práticas - Fontes de Referência}

\subsection*{Questão 24}
\addcontentsline{toc}{subsection}{Questão 24}

\textbf{Reprojetar o circuito com modificações para reduzir a sua sensibilidade a variações de $V_{DD}$. Tomar cuidado para que as dimensões não aumentem muito e que a faixa de operação não seja muito reduzida. Apresente o esquemático do circuito, com as dimensões escolhidas, e o novo gráfico $I_S$ x $V_{DD}$.}

\textbf{[PARTE PRÁTICA - A FAZER]}

\textbf{Parâmetros base para Is = 25µA:}
\begin{itemize}
    \item M = 2, N = 8, X = 1
    \item R = 3031$\Omega$
    \item Dimensões conforme Tabela \ref{tab:dimensoes}
\end{itemize}

\subsection*{Questão 25}
\addcontentsline{toc}{subsection}{Questão 25}

\textbf{Alguns circuitos analógicos necessitam de um circuito de start-up para começarem a funcionar (por exemplo, fontes de corrente, osciladores, etc.). Verifique por simulação se a fonte de corrente necessita de um start-up (considere algumas tensões iniciais nos nós do circuito e verifique, através de simulação de transitório, se o circuito vai ou não para o ponto de operação correto). Caso haja alguma condição inicial em que o circuito não funcione, apresente figura da simulação. Qual comando deve ser utilizado para impor condições iniciais, .IC ou .NODESET?}

\textbf{[PARTE PRÁTICA - A FAZER]}

\subsection*{Questão 26}
\addcontentsline{toc}{subsection}{Questão 26}

\textbf{Ajustar o valor de R para que a corrente em M5 tenha o valor nominal desejado quando $V_{DD} = 3,0V$.}

\textbf{[PARTE PRÁTICA - A FAZER]}

\textit{Resultado esperado: R = 6652 ohm}

\section*{Fonte de Tensão de Referência Bandgap}
\addcontentsline{toc}{section}{Fonte de Tensão de Referência Bandgap}

Grandezas PTAT (Proportional To Absolute Temperature), como a corrente da fonte de corrente, e CTAT (Complementary To Absolute Temperature), como o $V_{BE}$ de um bipolar, podem ser utilizadas para gerar um sinal independente da temperatura. Para isto basta somá-las, cada uma multiplicada por um coeficiente de ajuste, de forma que as variações com a temperatura se cancelem.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{example-image-i}
    \caption{Gráfico Tensão x Temperatura mostrando a soma de grandezas PTAT e CTAT.}
    \label{fig:ptat_ctat}
\end{figure}

Um circuito que realiza semelhante soma é apresentado na Figura \ref{fig:bandgap_ref}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-j}
    \caption{Fonte de tensão de referência bandgap.}
    \label{fig:bandgap_ref}
\end{figure}

Pode-se ver que:
\begin{itemize}
    \item A tensão de saída é igual à soma entre a tensão em R2, ($I_R \cdot R_2$) que é PTAT, e a tensão $V_{BE}$ do transistor;
    \item O valor de R2 serve para ajustar a relação entre essas duas tensões.
\end{itemize}

\subsection*{Questão 24}
\addcontentsline{toc}{subsection}{Questão 24}

\textbf{Projete uma fonte de tensão de referência similar à da figura 4 mas utilize a fonte de corrente que você projetou (questão 15). Na fonte de tensão faça com que a corrente do bipolar seja igual à corrente que passa pelo resistor R1 (Figura 4). O valor de R2 deve ser ajustado para que Coeficiente de Temperatura seja inferior a 50 ppm/$\degree$C, para a temperaturas variando entre $-10\degree$C e $100\degree$C. Apresente o esquemático do circuito completo, as dimensões dos transistores e os valores dos resistores. Apresente também o gráfico $V_{REF}$ x Temperatura.}

\textbf{[PARTE PRÁTICA - A FAZER]}

\textbf{Parâmetros da fonte de corrente (Is = 25µA):}
\begin{itemize}
    \item Fonte de corrente: 25µA (M=2, N=8, X=1, R=3031$\Omega$)
    \item Dimensões dos transistores conforme Tabela \ref{tab:dimensoes}
    \item Corrente do bipolar = 25µA
\end{itemize}

O Coeficiente de Temperatura é calculado como:

$$\text{Coeficiente de Temperatura} = \frac{V_{MAX} - V_{MIN}}{V_{NOM} \times (T_{MAX} - T_{MIN})} \times 10^6 \text{ ppm}/\degree\text{C}$$

onde:
\begin{itemize}
    \item $V_{MAX}$ = Máximo valor de $V_{REF}$ para $t \in [-10\degree\text{C}, 100\degree\text{C}]$
    \item $V_{MIN}$ = Mínimo valor de $V_{REF}$ para $t \in [-10\degree\text{C}, 100\degree\text{C}]$
    \item $V_{NOM}$ = Valor nominal de $V_{REF}$ (tipicamente em $27\degree\text{C}$)
    \item $T_{MAX} - T_{MIN} = 110\degree\text{C}$
\end{itemize}

\textit{Resultado esperado da prática original: R = 158,00 k$\Omega$, Coeficiente de temperatura = 28,34 ppm/$\degree$C}

\subsection*{Questão 25}
\addcontentsline{toc}{subsection}{Questão 25}

\textbf{Desenhe o layout da fonte de tensão completa. Utilize o transistor vertical PRIMLAB/VERT10 da biblioteca. Ajuste o comprimento de R2 no layout para que o coeficiente de temperatura do circuito extraído se mantenha abaixo de 50 ppm/$\degree$C.}

\textbf{Observação importante:} O transistor bipolar extraído vem com o parâmetro Area. Apagar este parâmetro senão ficará errado.

\textbf{[PARTE PRÁTICA - A FAZER]}

\subsection*{Questão 26}
\addcontentsline{toc}{subsection}{Questão 26}

\textbf{Adicionar ao layout Pads de VDD e GND. Passar o DRC para verificar se tudo está correto. Quais são as dimensões do circuito com os Pads? Apresentar o layout do circuito e o gráfico $V_{REF}$ x Temperatura para valores de VDD de 2,0V, 2,5V e 3,0V.}

\textbf{Observação:} Um bloco de Pad pode ser encontrado na biblioteca IOLIB\_4M, célula g-padonly.

\textbf{[PARTE PRÁTICA - A FAZER]}

\section*{Conclusão}
\addcontentsline{toc}{section}{Conclusão}

\textbf{[PARTE PRÁTICA - A FAZER]}

Neste projeto foram desenvolvidas fontes de corrente e tensão de referência utilizando tecnologia CMOS 0,35$\mu m$ da AMS. Os circuitos projetados demonstraram:

\begin{itemize}
    \item Funcionamento adequado da fonte de corrente de $25\mu A$ com baixa dependência da tensão de alimentação;
    \item Implementação bem-sucedida de uma fonte de tensão de referência bandgap com coeficiente de temperatura inferior a 50 ppm/$\degree$C;
    \item Técnicas de casamento de transistores para melhorar a precisão dos circuitos;
    \item Integração de componentes passivos (resistores) e ativos (transistores MOS e bipolares) em layout de circuito integrado.
\end{itemize}

Os resultados obtidos nas simulações pós-layout confirmaram a viabilidade dos projetos para aplicações que requerem referências precisas e estáveis com a temperatura, utilizando os parâmetros otimizados: M=2, N=8, X=1 e R=3031$\Omega$ para atingir Is=25µA.

\phantomsection
\addcontentsline{toc}{section}{Referências}
\begin{thebibliography}{99}
    \bibitem{ref1} Nome do Autor. ``Título do Artigo,'' Nome da Revista, vol. Volume, no. Número, pp. Páginas, Ano.
\end{thebibliography}

\end{document}