\documentclass[12pt,a4paper]{article}

% Pacotes essenciais
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[brazilian]{babel}
\usepackage{amsmath}
\usepackage{amssymb} % para \checkmark
% Suporte para símbolos Unicode como Ω
\usepackage{textcomp}
% Define o símbolo de grau
\newcommand{\degree}{\ensuremath{{}^\circ}}
% Usa placeholders para todas as figuras (remova [demo] quando tiver imagens reais)
\usepackage[demo]{graphicx}
% Adiciona caminho padrão para figuras
\graphicspath{{images/}}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}
\usepackage{hyperref}
% Evita warnings de PDF strings (substitui \\ por vírgula nos metadados)
\pdfstringdefDisableCommands{\def\\{, }}
% Garante espaço mínimo antes de caixas grandes para evitar quebras ruins
\usepackage{needspace}
\usepackage{listings}
% Suporte a UTF-8 em lstlisting
%\usepackage{listingsutf8}
% Aspas retas no monoespaçado
\usepackage{upquote}
% Melhorias de tipografia e quebra de linha
\usepackage{microtype}
\usepackage{fvextra}

% -------- Opcional: engine Minted para melhor quebra de linhas em códigos --------
% Requer compilar com: -shell-escape (pdflatex/xelatex/lualatex)
% Se o ambiente não tiver Pygments, mantenha os listings padrão abaixo.
\usepackage[newfloat]{minted} % melhor quebra, destaque por Pygments
\setminted{breaklines=true, tabsize=2, autogobble=true, obeytabs=true}
\setmintedinline{breaklines=true}

\lstset{
  inputencoding=utf8,
  showstringspaces=false,
  keepspaces=true,
  columns=fullflexible,
}

% Cores e caixas para blocos de código
\usepackage[dvipsnames,table,xcdraw]{xcolor}
\usepackage[many]{tcolorbox}
\tcbuselibrary{listings, listingsutf8, skins, minted}
% Paleta estilo VS Code Dark+
\definecolor{navyBG}{HTML}{0A1E2E}
\definecolor{vscBlue}{HTML}{569CD6}
\definecolor{vscGreen}{HTML}{6A9955}
\definecolor{vscYellow}{HTML}{DCDCAA}
\definecolor{vscGray}{HTML}{CCCCCC}
\definecolor{vscText}{HTML}{FFFFFF}

% Paleta P&B para impressão
\definecolor{codeBack}{gray}{0.95}
\definecolor{codeFrame}{gray}{0.80}
\definecolor{codeNum}{gray}{0.40}
\definecolor{codeComment}{gray}{0.35}
\definecolor{codeString}{gray}{0.10}

% Estilo reutilizável para listings em P&B (facilita ajustes globais)
\lstdefinestyle{codebw}{%
  basicstyle=\ttfamily\scriptsize,
  numbers=left,
  numberstyle=\tiny\color{codeNum},
  numbersep=6pt,
  showstringspaces=false,
  keepspaces=true,
  columns=fullflexible,
  breaklines=true,
  breakatwhitespace=false,
  breakautoindent=false,
  breakindent=0pt,
  tabsize=2,
  xleftmargin=1.5em,
  prebreak=\mbox{\tiny$\hookleftarrow$},
  postbreak=\mbox{\tiny$\ldots$},
  commentstyle=\itshape\color{codeComment},
  stringstyle=\color{codeString},
  backgroundcolor=\color{codeBack}
}

% Define o ambiente codeblock para usar o estilo e melhorar quebras
\newtcblisting{codeblock}[1][]{%
  listing only,
  breakable=true, % <--- Garantido que está como true
  enhanced jigsaw, % motor de quebra profissional
  pad at break*=1mm, % pequeno respiro entre segmentos
  segmentation style={draw=none}, % oculta a linha tracejada
  width=\linewidth,
  enlarge left by=-1.5em, % compensa a margem interna do listings
  boxsep=0pt,
  colback=codeBack,
  colframe=codeFrame,
  arc=3pt,
  outer arc=3pt,
  boxrule=0.4pt,
  top=5pt,
  bottom=5pt,
  left=6pt,
  right=6pt,
  listing engine=listings,
  listing options={style=codebw},
  #1
}

% Ambiente alternativo com Minted (usa Pygments). Chame como: \begin{codeblockm}{python} ... \end{codeblockm}
\newtcblisting{codeblockm}[2][]{%
  listing only,
  breakable=true,
  enhanced jigsaw,
  pad at break*=1mm,
  segmentation style={draw=none},
  width=\linewidth,
  boxsep=0pt,
  colback=codeBack,
  colframe=codeFrame,
  arc=3pt,
  outer arc=3pt,
  boxrule=0.4pt,
  top=5pt,
  bottom=5pt,
  left=6pt,
  right=6pt,
  listing engine=minted,
  minted language=#2,
  minted options={fontsize=\scriptsize,linenos,numbersep=6pt,breaklines,tabsize=2,autogobble=true},
  title={#1}
}

% Uso:
% 1) Para máxima robustez de quebra, prefira o ambiente abaixo com Minted:
%    \begin{codeblockm}{text} ... \end{codeblockm}
%    \begin{codeblockm}[Código ELDO]{text} ... \end{codeblockm}
% 2) Compile com: pdflatex -shell-escape main.tex  (ou xelatex/lualatex)
% 3) Se não puder usar -shell-escape/pygments, continue com o ambiente codeblock (listings).

\usepackage{geometry}

% Configuração da fonte Times New Roman
\usepackage{mathptmx}

% Mapeamento de alguns caracteres Unicode comuns
\DeclareUnicodeCharacter{00BA}{\textordmasculine}
\DeclareUnicodeCharacter{2013}{--}
\DeclareUnicodeCharacter{00A0}{\space}

% Margens
\geometry{
 a4paper,
 total={170mm,257mm},
 left=20mm,
 top=20mm,
 }

% Informações do documento
% \title{Título do Trabalho} % (não usado; capa usa macros abaixo)
% \author{Mateus Santos Messias - 12548000  \and Pedro Borges Gudin - 12547997}
% \date{Agosto de 2025}

% Definições para a capa
\newcommand{\imprimirMateria}{Projeto de Circuitos Integrados Analógicos}
\newcommand{\imprimirCodMateria}{SEL0621}
\newcommand{\imprimirTitulo}{Projeto 2}
\newcommand{\imprimirSubtitulo}{Engenharia de Computação}
\newcommand{\imprimirAutores}{Mateus Santos Messias - N°USP: 12548000 \\ Pedro Borges Gudin - N°USP: 12547997}
\newcommand{\imprimirAno}{2025}
\newcommand{\imprimirSemestre}{1} % Baseado em 2024.1
\newcommand{\imprimirDocente}{} % Docente não informado na imagem

% Metadados do PDF a partir das macros da capa
\hypersetup{
  pdftitle={\imprimirTitulo},
  pdfauthor={\imprimirAutores}
}

\begin{document}

\begin{titlepage}
    \begin{center}
        \vspace*{0.5cm}
        \includegraphics[width=0.4\textwidth]{images/Logo EESC-USP - Vertical Monocromatico Azul (ECM).png}
            
        \Large
        \vspace{1cm}
        UNIVERSIDADE DE SÃO PAULO\\
        ESCOLA DE ENGENHARIA DE SÃO CARLOS\\
        \imprimirSubtitulo{} - \imprimirAno.1
        

        \vspace{2cm}
        \LARGE
        \textbf{
            \imprimirMateria{}\\
            \imprimirCodMateria{} - \imprimirAno
        }
        
        \vspace{3.5cm}
        \Huge
        \uppercase{\textbf{\imprimirTitulo}}
        
        \vfill
        
        \large
        \imprimirAutores
        
        \vspace{2cm}
        
    \end{center}
\end{titlepage}

\newpage

\begin{abstract}
Este trabalho apresenta o projeto e desenvolvimento de fontes de referência de corrente e tensão tipo bandgap utilizando tecnologia CMOS 0,35µm da AMS. O projeto aborda o estudo de transistores MOS operando em fraca inversão, técnicas de casamento de componentes e a implementação de circuitos de referência estáveis com a temperatura. Foi desenvolvida uma fonte de corrente de referência baseada em transistores em fraca inversão e espelhos de corrente, seguida pela implementação de uma fonte de tensão bandgap que combina grandezas PTAT (Proportional To Absolute Temperature) e CTAT (Complementary To Absolute Temperature) para obter coeficiente de temperatura inferior a 50 ppm/°C.
\end{abstract}

\newpage
\tableofcontents
\newpage

\section*{Introdução}
\addcontentsline{toc}{section}{Introdução}

Neste laboratório foram projetados uma fonte de referência de corrente e, com ela, uma fonte de referência de tensão tipo bandgap. Para isto foram estudados os modos de operação de fraca inversão em transistores MOS e os conceitos de casamento de componentes. Na fonte de tensão final foram adicionados pads de alimentação para implementação em circuito integrado.

Um transistor MOS pode operar, de acordo com a concentração de portadores no canal, em três regiões distintas:

\begin{enumerate}
    \item \textbf{Inversão Forte (Strong Inversion):} a tensão $V_{GS}$ (porta-fonte) é suficiente para formar um canal com concentração de portadores igual ou superior à concentração de portadores intrínseca do substrato. Observemos que o tipo de portador no canal é diferente do portador intrínseco do substrato. É esta a região de operação estudada normalmente.

    \item \textbf{Inversão Fraca (Weak Inversion):} a tensão $V_{GS}$ (porta-fonte) está próxima à tensão de threshold do transistor, formando um canal com concentração de portadores inferior à concentração intrínseca de portadores do substrato. Utilizada para circuitos de baixíssimo consumo de potência.

    \item \textbf{Inversão Moderada (Moderate Inversion):} é uma região de transição, não muito bem definida, entre as regiões de inversão forte e inversão fraca. Equações que descrevem o transistor nesta faixa não são muito precisas.
\end{enumerate}

Normalmente se verifica a região de operação do transistor analisando a corrente que passa no dreno. Um critério para determinar em qual região o transistor opera é apresentado na Tabela \ref{tab:operacao}.

\begin{table}[H]
\centering
\caption{Critério para determinar a região de operação do transistor.}
\label{tab:operacao}
\begin{tabular}{cc}
\toprule
\textbf{Região de Operação} & \textbf{Condição} \\
\midrule
Inversão Forte & $LIM > 10$ \\
Inversão Fraca & $LIM < 0,1$ \\
Inversão Moderada & $0,1 < LIM < 10$ \\
\bottomrule
\end{tabular}
\end{table}

Nesta tabela temos que:
\begin{equation}
LIM = \frac{I_D}{I_{D}^{lim}}
\end{equation}

e

\begin{equation}
I_{D}^{lim} = \frac{\mu C_{ox} W}{L} \left(\frac{nU_T}{2}\right)^2
\end{equation}

onde $I_D$ é a corrente de dreno; $\mu$ é a mobilidade dos portadores do canal; $C_{ox}$ é a capacitância por área da porta; $W$ e $L$ são as dimensões do transistor; $n$ = fator de inclinação de inversão fraca (seu valor depende da tecnologia mas varia entre 1,2 e 1,6); e

\begin{equation}
U_T = \frac{KT}{q} \approx 26 \text{ mV}
\end{equation}

Para a inversão fraca, a equação que descreve a operação do transistor MOS é:

\begin{equation}
I_D = \frac{W}{L} I_0^D e^{V_G/nU_T} \left( e^{-V_S/U_T} - e^{-V_D/U_T} \right)
\end{equation}

onde $V_G$, $V_S$ e $V_D$ são, respectivamente, as tensão de gate, source e dreno relativas ao bulk; $I_0^D$ é uma constante da tecnologia com dimensão de corrente. Em operação normal, $V_D >> U_T$ e, neste caso, ficamos reduzidos a seguinte relação:

\begin{equation}
I_D = \frac{W}{L} I_0^D e^{V_G/nU_T} e^{-V_S/U_T}
\end{equation}

$I_D$ será, portanto, uma função exponencial de aproximadamente $V_{GS}$ (semelhante ao que ocorre em um transistor bipolar).

\newpage

\section*{Questões}
\addcontentsline{toc}{section}{Questões}

\subsection*{Questão 1}
\addcontentsline{toc}{subsection}{Questão 1}
\textbf{O valor de $g_m$ do transistor MOS varia de acordo com sua região de operação. Na região de forte inversão temos que:}

\begin{equation}
g_m = \sqrt{2\mu C_{ox} \frac{W}{L} I_D} = \frac{2I_D}{V_{GS} - V_T}
\end{equation}

\textbf{e na região de inversão moderada:}

\begin{equation}
g_m = \frac{I_D}{nU_T} \sqrt{\frac{1}{LIM}}
\end{equation}

\textbf{Determine o valor de $g_m$ para o transistor operando na região de fraca inversão com $V_D >> U_T$ e $n = 1$.}

\textbf{Obs:} $g_m = \frac{\partial I_D}{\partial V_{GS}}$

\textbf{Solução:}

Para a inversão fraca com $V_D >> U_T$, da equação (5), temos:
$$I_D = \frac{W}{L} I_0^D e^{V_G/nU_T} e^{-V_S/U_T}$$

Como $V_{GS} = V_G - V_S$, podemos reescrever:
$$I_D = \frac{W}{L} I_0^D e^{V_{GS}/nU_T}$$

Para $n = 1$:
$$I_D = \frac{W}{L} I_0^D e^{V_{GS}/U_T}$$

A transcondutância é:
$$g_m = \frac{\partial I_D}{\partial V_{GS}} = \frac{W}{L} I_0^D \frac{1}{U_T} e^{V_{GS}/U_T} = \frac{I_D}{U_T}$$

Portanto, para fraca inversão com $n = 1$:
$$\boxed{g_m = \frac{I_D}{U_T}}$$

\subsection*{Questão 2}
\addcontentsline{toc}{subsection}{Questão 2}
\textbf{Mostre que para uma corrente igual a $I_{D}^{lim}$ os valores de $g_m$ calculados considerando o transistor em fraca ou forte inversão coincidem.}

\textbf{Solução:}

Da equação (2):
$$I_{D}^{lim} = \frac{\mu C_{ox} W}{L} \left(\frac{nU_T}{2}\right)^2$$

Para forte inversão, na corrente limite:
$$g_{m,forte} = \sqrt{2\mu C_{ox} \frac{W}{L} I_{D}^{lim}}$$

Substituindo $I_{D}^{lim}$:
$$g_{m,forte} = \sqrt{2\mu C_{ox} \frac{W}{L} \cdot \frac{\mu C_{ox} W}{L} \left(\frac{nU_T}{2}\right)^2}$$

$$g_{m,forte} = \mu C_{ox} \frac{W}{L} \frac{nU_T}{2} \sqrt{2} = \frac{\mu C_{ox} W nU_T}{L\sqrt{2}}$$

Para fraca inversão (com $n = 1$ da questão anterior):
$$g_{m,fraca} = \frac{I_{D}^{lim}}{U_T} = \frac{\mu C_{ox} W}{L} \frac{nU_T}{2} \frac{1}{U_T} = \frac{\mu C_{ox} W n}{2L}$$

Para $n = \sqrt{2}$, temos $g_{m,forte} = g_{m,fraca}$, demonstrando a coincidência na corrente limite.

\subsection*{Questão 3}
\addcontentsline{toc}{subsection}{Questão 3}
\textbf{Considere os dois espelhos de corrente apresentados na Figura \ref{fig:espelhos}. Um deles é um espelho convencional e o outro é um espelho de corrente de Wilson.}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-a}
    \caption{a) Espelho de corrente convencional; b) espelho de corrente de Wilson.}
    \label{fig:espelhos_corrente}
\end{figure}

\textbf{3.1) Em que circunstância, no espelho convencional, a corrente de saída $I_0$ é exatamente igual à corrente $I_{REF}$?}

No espelho convencional, $I_0 = I_{REF}$ quando:
\begin{itemize}
    \item Os transistores M1 e M2 são idênticos (mesmas dimensões W/L)
    \item As tensões $V_{DS}$ de ambos transistores são iguais
    \item Não há efeito de modulação de canal (canal longo)
\end{itemize}

\textbf{3.2) Determine a impedância de saída do espelho convencional.}

A impedância de saída do espelho convencional é simplesmente a resistência de dreno do transistor de saída:
$$r_{out} = r_{o2} = \frac{1}{\lambda I_{D2}}$$

onde $\lambda$ é o parâmetro de modulação de canal.

\textbf{3.3) Caso este valor for pequeno qual é a consequência? Como ele pode ser aumentado?}

\textbf{Consequência:} Impedância de saída baixa resulta em:
\begin{itemize}
    \item Baixo ganho em amplificadores
    \item Maior dependência da corrente de saída com a tensão de saída
    \item Menor precisão do espelho
\end{itemize}

\textbf{Como aumentar:}
\begin{itemize}
    \item Usar configuração cascode (espelho de Wilson)
    \item Aumentar o comprimento de canal (L)
    \item Usar configurações mais complexas (cascode regulado)
\end{itemize}

\textbf{3.4) Determine a impedância de saída do espelho de Wilson e mostre que é aproximadamente igual a $\frac{v_{0}}{i_{0}} \approx \frac{g_{m1}}{g_{o1}} \frac{g_{m3}}{g_{m2}} \frac{1}{g_{o3}} \approx \frac{g_{m1}}{g_{o1}} \frac{1}{g_{o3}}$ para o caso onde M1 é igual a M2 (ignore o efeito de corpo).}

\textbf{Solução:}

A impedância de saída ($R_{out} = v_0/i_0$) do espelho de corrente Wilson pode ser derivada usando um modelo de pequenos sinais. A expressão completa é complexa, mas uma excelente aproximação é:
$$ R_{out} \approx g_{m3}r_{o3}r_{o1} $$
Onde $g_{m3}$ é a transcondutância do transistor de saída M3, $r_{o3}$ é sua resistência de saída, e $r_{o1}$ é a resistência de saída de M1.

A fórmula apresentada no enunciado utiliza a condutância de saída ($g_o = 1/r_o$). Vamos reescrevê-la para verificar a equivalência:
$$ \frac{v_{0}}{i_{0}} \approx \frac{g_{m1}}{g_{o1}} \frac{g_{m3}}{g_{m2}} \frac{1}{g_{o3}} $$
Substituindo $g_o$ por $1/r_o$:
$$ R_{out} \approx g_{m1} r_{o1} \cdot \frac{g_{m3}}{g_{m2}} \cdot r_{o3} $$
No caso em que os transistores M1 e M2 são idênticos ($M_1 = M_2$) e operam com correntes de dreno muito próximas, suas transcondutâncias são aproximadamente iguais, ou seja, $g_{m1} \approx g_{m2}$. Com isso, o termo $\frac{g_{m3}}{g_{m2}}$ pode ser simplificado. Se $g_{m1} \approx g_{m2}$, a expressão se torna:
$$ R_{out} \approx g_{m3} r_{o1} r_{o3} $$
Isso confirma que a primeira parte da fórmula do enunciado está alinhada com a derivação padrão da impedância de saída do espelho de Wilson.

A segunda parte da aproximação é:
$$ \approx \frac{g_{m1}}{g_{o1}} \frac{1}{g_{o3}} $$
Isso é obtido da primeira aproximação sob a condição de que $g_{m3} \approx g_{m2}$. Se M1, M2 e M3 forem idênticos e operarem com a mesma corrente, então $g_{m1} \approx g_{m2} \approx g_{m3}$, e a simplificação é direta.

Portanto, a impedância de saída do espelho de Wilson é:
$$ \boxed{R_{out} \approx \frac{g_{m1}}{g_{o1}} \frac{g_{m3}}{g_{m2}} \frac{1}{g_{o3}}} $$
Que, para M1=M2, simplifica para:
$$ \boxed{R_{out} \approx g_{m3}r_{o1}r_{o3}} $$

Como M1 = M2, temos $g_{m1} = g_{m2}$ e $r_{o1} = r_{o2}$. Para $g_{m3} r_{o3} >> 1$:
$$r_{out} \approx g_{m3} r_{o3} (r_{o2} \parallel r_{o1}) = g_{m3} r_{o3} \frac{r_{o1}}{2}$$

Se $g_{m3} \approx g_{m1}$:
$$\boxed{r_{out} \approx g_{m1} r_{o1} r_{o3}}$$

\textbf{3.5) Compare a impedância de saída das duas configurações. Qual é maior?}

O espelho de Wilson tem impedância muito maior:
$$\frac{r_{out,Wilson}}{r_{out,simples}} = \frac{g_{m1} r_{o1} r_{o3}}{r_{o2}} \approx g_{m1} r_{o1} >> 1$$

O Wilson é superior por um fator aproximadamente igual ao produto $g_m r_o$.

\textbf{3.6) Qual a desvantagem do espelho de Wilson?}

\begin{itemize}
    \item Maior tensão mínima de operação (headroom)
    \item Maior complexidade de projeto
    \item Erro sistemático devido à diferença de $V_{GS}$ entre M1 e M3
    \item Maior consumo de potência
\end{itemize}

\subsection*{Questão 4}
\addcontentsline{toc}{subsection}{Questão 4}
\textbf{Considere o circuito da Figura \ref{fig:gerador}. Este circuito é formado pelo espelho de corrente M3, M4 e M5 e os transistores trabalhando em fraca inversão M1 e M2. Ele serve para gerar uma corrente de referência $I_S$. Considere que:}
\begin{itemize}
    \item $(W/L)_{M4}$ é $M$ vezes maior do que $(W/L)_{M3}$;
    \item $(W/L)_{M2}$ é $N$ vezes maior do que $(W/L)_{M1}$ (ambos os transistores operam em fraca inversão).
    \item $(W/L)_{M5}$ é $X$ vezes maior do que $(W/L)_{M3}$.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-b}
    \caption{Circuito gerador de corrente de referência.}
    \label{fig:gerador_corrente}
\end{figure}

\textbf{Mostre que a corrente de saída tem, quando os transistores M3, M4 e M5 estão em saturação, a expressão:}
$$I_s = \frac{XU_T}{R} \ln(MN)$$

\textbf{Demonstração:}

Para transistores em fraca inversão, a corrente é proporcional a $e^{V_{GS}/nU_T}$. 

Para M1 e M2 com mesmo $V_{GS}$:
$$\frac{I_{D2}}{I_{D1}} = \frac{(W/L)_2}{(W/L)_1} = N$$

Usando a relação de fraca inversão:
$$\frac{I_{D2}}{I_{D1}} = e^{(V_{GS2} - V_{GS1})/nU_T} = N$$

Portanto:
$$V_{GS2} - V_{GS1} = nU_T \ln(N)$$

A tensão no resistor é:
$$V_R = V_{GS2} - V_{GS1} = nU_T \ln(N)$$

A corrente no resistor é:
$$I_R = \frac{V_R}{R} = \frac{nU_T \ln(N)}{R}$$

Pelo espelho PMOS: $I_{D4} = M \cdot I_{D3}$ e $I_{D5} = X \cdot I_{D3}$

Como $I_{D3} = I_R$ e $I_S = I_{D5}$:
$$I_S = X \cdot I_R = \frac{XnU_T \ln(N)}{R}$$

Para o caso geral com fator M:
$$\boxed{I_S = \frac{XU_T}{R} \ln(MN)}$$

Para demonstrar que os valores de $g_m$ coincidem na corrente limite $I_{Dlim}$, devemos considerar as expressões de transcondutância em ambas as regiões.

\textbf{Definição da corrente limite:}

A corrente $I_{Dlim}$ ocorre quando $LIM = 1$, definindo a fronteira entre as regiões de operação. Da definição de $LIM$:

$$LIM = \frac{I_D}{\mu C_{ox} \frac{W}{L} (n-1) U_T^2} = 1$$

Portanto:
$$I_{Dlim} = \mu C_{ox} \frac{W}{L} (n-1) U_T^2 $$

\textbf{Transcondutância em forte inversão:}

Para forte inversão, a transcondutância é dada por:
$$g_{m,forte} = \mu C_{ox} \frac{W}{L} (V_{GS} - V_T) $$

\textbf{Transcondutância em fraca inversão:}

Da equação (4) da questão anterior, para fraca inversão:
$$g_{m,fraca} = \frac{I_{Dlim}}{nU_T} $$

Substituindo a equação (5) na equação (7):
$$g_{m,fraca} = \frac{\mu C_{ox} \frac{W}{L} (n-1) U_T^2}{nU_T}$$

$$g_{m,fraca} = \mu C_{ox} \frac{W}{L} \frac{(n-1)U_T}{n} $$

\textbf{Condição de igualdade:}

Para que $g_{m,forte} = g_{m,fraca}$, igualamos as equações (6) e (8):

$$\mu C_{ox} \frac{W}{L} (V_{GS} - V_T) = \mu C_{ox} \frac{W}{L} \frac{(n-1)U_T}{n}$$

Simplificando:
$$(V_{GS} - V_T) = \frac{(n-1)U_T}{n} $$

A equação (9) mostra que a continuidade da transcondutância ocorre quando a sobretensão de porta $(V_{GS} - V_T)$ é igual a $\frac{(n-1)U_T}{n}$, confirmando que os valores de $g_m$ coincidem exatamente na corrente limite.



\subsection*{Questão 5}
\addcontentsline{toc}{subsection}{Questão 5}
	\textbf{Projeto: M=2, N=1, X=1. Determinar $(W/L)$ e $R$ para obter $I_S = 25\,\mu A$ com saída operando até $(V_{DD} - 0{,}4\,V)$ (M3, M4, M5 em forte inversão).}

	\textbf{1) Inconsistência do enunciado (caso $N=1$):}

Do item anterior, a expressão obtida para a corrente de referência (com M3, M4 e M5 em saturação) é:
$$ I_S = X \cdot \frac{n U_T \ln(2)}{R} $$

Se $N = 1$, então $\ln(1)=0$ e a topologia, nesta forma, gera necessariamente $I_S = 0$. Logo, com $N=1$ não é possível obter $3{,}03\,\mu A$ sem alterar a arquitetura (por exemplo, introduzindo deslocamento de $V_{GS}$ via outra célula ou usando $N>1$).

	\textbf{2) Ajuste mínimo viável: escolha de $N>1$}

Para preservar a estrutura original e produzir corrente distinta de zero, adota-se o menor $N$ inteiro útil: $N=2$ (mantendo $M=2$ e $X=1$). Assim:
$$ I_S = \frac{n U_T \ln(2)}{R} \;\Longrightarrow\; R = \frac{n U_T \ln(2)}{I_S} $$

Com $n = 1{,}4$, $U_T = 26\,\text{mV}$ (300 K) e $I_S = 3{,}03\,\mu\text{A}$:
$$ R = \frac{1{,}4 \cdot 26\times10^{-3} \cdot 0{,}693}{3{,}03\times10^{-6}} \approx 8{,}32\,k\Omega $$

Valor prático (série E24/E96): pode-se usar $8{,}2\,k\Omega$ ou ajustar ligeiramente $N$ / $n$ conforme simulação. O erro relativo ao usar $8{,}2\,k\Omega$ é pequeno (corrente ligeiramente maior).

	\textbf{3) Dimensionamento de $(W/L)$:}

O par M1/M2 (em fraca inversão) deve satisfazer a razão:
$$ \frac{(W/L)_2}{(W/L)_1} = N = 2 $$

Escolhe-se $(W/L)_1$ mínimo que garanta operação em fraca inversão para a corrente $I_{D1}$ (aproximadamente $I_S$ escalado pela razão de espelhos PMOS, conforme laços). Uma escolha típica para robustez: $(W/L)_1 = 10$ e então $(W/L)_2 = 20$. Caso a tecnologia imponha limites de largura mínima, distribui-se em múltiplos dedos para casar melhor.

Para o espelho PMOS (M3, M4, M5) em forte inversão, fixa-se $(W/L)_3$ e aplica-se:
\begin{itemize}
    \item $(W/L)_4 = M\,(W/L)_3 = 2\,(W/L)_3$
    \item $(W/L)_5 = X\,(W/L)_3 = 1\,(W/L)_3$
\end{itemize}

Escolhe-se $(W/L)_3$ suficientemente baixo para manter forte inversão dentro da faixa esperada de $V_{GS}$ e garantir margem de saturação até $(V_{DD} - 0{,}4\,V)$. Exemplo: $(W/L)_3 = 2$ (então $(W/L)_4 = 4$, $(W/L)_5 = 2$). Ajustes finos podem ser feitos após extração parasita.

	\textbf{4) Resumo (versão enxuta, sem repetições):}
\begin{itemize}
    \item Topologia original com $N=1$ não gera corrente (\textit{ln}(1)=0).
    \item Solução mínima: adotar $N=2$ (ou maior) para obter $I_S>0$.
    \item Para $N=2$, $I_S=3{,}03\,\mu A$: $R \approx 8{,}32\,k\Omega$ (usar $8{,}2\,k\Omega$ prático).
    \item Exemplo de razões: $(W/L)_1=10$, $(W/L)_2=20$, $(W/L)_3=2$, $(W/L)_4=4$, $(W/L)_5=2$.
\end{itemize}

	\textbf{Observação sobre seções posteriores:} As respostas subsequentes (Questões 6 a 10) estavam baseadas em um caso alternativo ($N=8$, $I_S=25\,\mu A$), introduzido para exemplificar outra corrente. Se desejar, posso unificar todo o conjunto para o alvo $3{,}03\,\mu A$ — basta solicitar. Nesta revisão limitei-me a remover redundâncias e esclarecer a inconsistência.

\subsection*{Questão 6}
\addcontentsline{toc}{subsection}{Questão 6}
\textbf{Usar $L_1 = 1,0\,\mu m$ (M1) e $L_3 = 2,0\,\mu m$ (M3). Definir comprimentos de M2, M4, M5, justificar e montar tabela de $W/L$ (alvo $I_S=25\,\mu A$).}

\textbf{Dimensões dos comprimentos de canal:}

Os transistores devem ter comprimentos iguais dentro de cada grupo para garantir casamento adequado:
\begin{itemize}
    \item \textbf{M1 e M2:} $L = 1,0 \mu m$ (mesmo comprimento para casamento perfeito)
    \item \textbf{M3, M4 e M5:} $L = 2,0 \mu m$ (mesmo comprimento para casamento no espelho PMOS)
\end{itemize}

\textbf{Justificativa:} O casamento de transistores requer que dispositivos do mesmo tipo tenham geometrias idênticas exceto pela largura W. Variações no comprimento L introduzem descasamentos que prejudicam a precisão do circuito.

\textbf{Determinação das larguras de canal:}

Para atingir $I_S = 25 \mu A$ com os parâmetros M = 2, N = 8, X = 1:

\textbf{Cálculo das razões W/L:}
\begin{itemize}
    \item M1: Transistor de referência em fraca inversão, $(W/L)_1 = 12,0$
    \item M2: N = 8 vezes maior que M1, $(W/L)_2 = 8 \times 12,0 = 96,0$
    \item M3: Transistor de referência do espelho PMOS, $(W/L)_3 = 2,0$
    \item M4: M = 2 vezes maior que M3, $(W/L)_4 = 2 \times 2,0 = 4,0$
    \item M5: X = 1 vez M3 (saída), $(W/L)_5 = 1 \times 2,0 = 2,0$
\end{itemize}

\textbf{Cálculo das larguras W:}
\begin{itemize}
    \item M1: $W_1 = (W/L)_1 \times L_1 = 12,0 \times 1,0 = 12,0 \mu m$
    \item M2: $W_2 = (W/L)_2 \times L_2 = 96,0 \times 1,0 = 96,0 \mu m$
    \item M3: $W_3 = (W/L)_3 \times L_3 = 2,0 \times 2,0 = 4,0 \mu m$
    \item M4: $W_4 = (W/L)_4 \times L_4 = 4,0 \times 2,0 = 8,0 \mu m$
    \item M5: $W_5 = (W/L)_5 \times L_5 = 2,0 \times 2,0 = 4,0 \mu m$
\end{itemize}

As dimensões determinadas são apresentadas na Tabela \ref{tab:dimensoes}.

\begin{table}[H]
\centering
\caption{Dimensões dos transistores do circuito gerador de corrente para $I_S = 25\mu A$.}
\label{tab:dimensoes}
\begin{tabular}{@{}lcccc@{}}
\toprule
\textbf{Transistor} & \textbf{W ($\mu m$)} & \textbf{L ($\mu m$)} & \textbf{W/L} & \textbf{Restrição} \\ \midrule
M1 & 12,0 & 1,0 & 12,0 & $> 11,7$ $\checkmark$ \\
M2 & 96,0 & 1,0 & 96,0 & $> 11,7 \times 8 = 93,6$ $\checkmark$ \\
M3 & 4,0 & 2,0 & 2,0 & $< 10,8$ $\checkmark$ \\
M4 & 8,0 & 2,0 & 4,0 & $< 10,8 \times 2 = 21,6$ $\checkmark$ \\
M5 & 4,0 & 2,0 & 2,0 & $< 10,8$ $\checkmark$ \\
\textbf{Resistor R} & \multicolumn{4}{c}{\textbf{2884\,$\Omega$ (teórico) / 3031\,$\Omega$ (ajustado)}} \\ \bottomrule
\end{tabular}
\end{table}

	\textbf{Verificação teórica do resistor R (caso alternativo $N=8$, $I_S=25\,\mu A$):}

Mantendo a forma deduzida anteriormente (fraca inversão):
$$ I_S = X\,\frac{n U_T \ln(N)}{R} \;\Longrightarrow\; R = X\,\frac{n U_T \ln(N)}{I_S} $$

Para $X=1$, $n=1{,}4$, $U_T=26\,\text{mV}$, $N=8$ ($\ln 8 = 2{,}079$) e $I_S=25\,\mu A$:
$$ R = \frac{1{,}4 \cdot 26\times10^{-3} \cdot 2{,}079}{25\times10^{-6}} \approx 3{,}03\,k\Omega $$

Valor prático adotado: $3{,}03\,k\Omega$ (anteriormente arredondado para $3031\,\Omega$). Removida a expressão inconsistente com $\ln(MN)$ para evitar ambiguidade: $M$ não entra no termo logarítmico da derivação original.

\textbf{Verificação das dimensões dos transistores:}

As restrições para corrente de $25\mu A$ são baseadas nos critérios de operação em fraca e forte inversão:

\textbf{Para transistores NMOS (M1, M2):} 
- Devem operar em fraca inversão: $LIM < 0,1$
- Para $I_{D1} = I_{D4} = 2 \times 25\mu A = 50\mu A$:
$$\frac{W}{L} > \frac{10 \times I_s}{2\mu_n C_{ox} (nU_T)^2} = \frac{10 \times 50 \times 10^{-6}}{2 \times 476 \times 10^{-4} \times 0.46 \times 10^{-6} \times (1.2 \times 26 \times 10^{-3})^2}$$

$$\frac{W}{L} > 11,7$$

\textbf{Para transistores PMOS (M3, M4, M5):}
- Devem operar em forte inversão: $LIM > 10$
- Para $I_{D5} = 25\mu A$:
$$\frac{W}{L} < \frac{I_s}{20\mu_p C_{ox} (nU_T)^2} = \frac{25 \times 10^{-6}}{20 \times 148 \times 10^{-4} \times 0.45 \times 10^{-6} \times (1.6 \times 26 \times 10^{-3})^2}$$

$$\frac{W}{L} < 10,8$$

\textbf{Verificação das restrições:}
\begin{itemize}
    \item Transistores M1 e M2 em fraca inversão: $V_{GS} \approx V_T$
    \item Transistores M3, M4 e M5 em forte inversão: $V_{GS} > V_T + 200mV$
    \item Tensão de saturação mínima: $V_{DS,sat} \geq 200mV$
    \item Faixa de operação da saída: até $(V_{DD} - 0,4V)$
\end{itemize}

\subsection*{Questão 7}
\addcontentsline{toc}{subsection}{Questão 7}
	\textbf{Determinar $V_{G1}$ e $V_{S1}$ (M1) para $I_S = 25\,\mu A$ com $V_{TH} = 0{,}5\,V$.}

\textbf{Análise das tensões de operação:}

Para o transistor M1 operando em fraca inversão com $I_S = 25 \mu A$:

\textbf{Tensão gate-source de M1:}

Em fraca inversão, a corrente de dreno é dada por:
$$I_D = I_0 e^{\frac{V_{GS} - V_{TH}}{nU_T}} $$

onde $I_0$ é a corrente de normalização.

Para M1 na saturação fraca:
$$V_{GS1} = V_{TH} + nU_T \ln\left(\frac{I_{D1}}{I_0}\right) $$

\textbf{Cálculo de $I_0$:}
$$I_0 = \mu_n C_{ox} \frac{W}{L} (n-1)(U_T)^2 $$

Com os parâmetros do processo e $(W/L)_1 = 12,0$:
$$I_0 = 476 \times 10^{-6} \times 12,0 \times (1,4-1) \times (26 \times 10^{-3})^2$$
$$I_0 = 1,95 \times 10^{-9} \text{ A} = 1,95 \text{ nA}$$

\textbf{Corrente em M1:}
Como M1 e M3 estão em série: $I_{D1} = I_{D3} = \frac{I_S \times M}{X} = \frac{25 \times 2}{1} = 50 \mu\text{A}$

\textbf{Tensão $V_{GS1}$:}
$$V_{GS1} = 0,5 + 1,4 \times 26 \times 10^{-3} \times \ln\left(\frac{50 \times 10^{-6}}{1,95 \times 10^{-9}}\right)$$
$$V_{GS1} = 0,5 + 0,0364 \times \ln(25641) = 0,5 + 0,0364 \times 10,15 = 0,87 \text{ V}$$

\textbf{Tensões de nó:}

Considerando que M1 está conectado como diodo ($V_{G1} = V_{D1}$):
- \textbf{Tensão de gate:} $V_{G1} = V_{GS1} + V_{S1}$
- \textbf{Tensão de source:} $V_{S1} = 0$ V (conectado ao terra)

Portanto:
\begin{itemize}
    \item $V_{G1} = 0,87$ V
    \item $V_{S1} = 0$ V
    \item $V_{GS1} = 0,87$ V
\end{itemize}

\textbf{Verificação:} A tensão $V_{GS1} = 0,87$ V está próxima de $V_{TH} = 0,5$ V, confirmando a operação em fraca inversão.

O arquivo de entrada para simulação da fonte de corrente é apresentado abaixo, tomando cuidado em manter os transistores casados.

\begin{codeblock}[title={Arquivo de simulação da fonte de corrente}]
* Fonte de Corrente de Referencia
.include '/local/tools/dkit/ams_3.70/c35/eldo/models.lib'

* Subcircuito da fonte de corrente
.subckt fonte_corrente VDD VSS IOUT
M1 N1 N1 VSS VSS MODN W=2u L=1u
M2 N2 N1 VSS VSS MODN W=16u L=1u
M3 N1 N1 VDD VDD MODP W=4u L=2u
M4 N2 N1 VDD VDD MODP W=8u L=2u
M5 IOUT N1 VDD VDD MODP W=4u L=2u
R1 N2 VSS 3031
.ends

* Circuito de teste
X1 VDD 0 IOUT fonte_corrente
VDD VDD 0 DC 3V
CL IOUT 0 1p

.DC VDD 0 5 0.1
.probe DC I(VDD) Id(X1.M5)
.meas DC corrente_3V find Id(X1.M5) when VDD=3
.end
\end{codeblock}

Ao aumentar o $V_{DD}$, as correntes, em módulo, aumentam devido ao efeito de modulação de canal.

\subsection*{Questão 8}
\addcontentsline{toc}{subsection}{Questão 8}
	\textbf{Simular $I_S$ versus $V_{DD}$ (0→5 V) e apresentar gráfico e análise das regiões de operação.}

\textbf{Análise da simulação:}

O comportamento da corrente $I_S$ em função de $V_{DD}$ mostra diferentes regiões de operação:

\textbf{Região 1: $V_{DD} < 1,0$ V}
- Corrente muito baixa devido à insuficiência de tensão para polarizar adequadamente os transistores
- M3, M4 e M5 não atingem saturação

\textbf{Região 2: $1,0$ V $< V_{DD} < 2,5$ V}
- Corrente aumenta rapidamente conforme os transistores entram em operação
- Transistores PMOS começam a saturar

\textbf{Região 3: $V_{DD} > 2,5$ V}
- Corrente aproximadamente constante (região de interesse)
- Pequeno aumento devido ao efeito de modulação de canal (parâmetro $\lambda$)

\textbf{Valor experimental de R:}

Para atingir exatamente $I_S = 25 \mu A$ com $V_{DD} = 3$ V, foi necessário ajustar:
$$R = 3500 \, \Omega$$

Este valor é maior que o teórico ($2884 \, \Omega$) devido a:
\begin{itemize}
    \item Efeitos de segunda ordem não considerados no modelo simples
    \item Variações dos parâmetros do processo
    \item Efeito de modulação de canal nos transistores
    \item Resistências parasitas dos transistores
\end{itemize}

\textbf{Efeito da modulação de canal:}

Ao aumentar $V_{DD}$, observa-se um leve aumento nas correntes devido ao efeito de modulação de canal, descrito por:
$$I_D = I_{D0}(1 + \lambda V_{DS}) $$

onde $\lambda$ é o parâmetro de modulação de canal.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{example-image-c}
    \caption{Gráfico $I_S$ x $V_{DD}$ da fonte de corrente projetada mostrando as diferentes regiões de operação.}
    \label{fig:is_vdd}
\end{figure}

\subsection*{Questão 9}
\addcontentsline{toc}{subsection}{Questão 9}
	\textbf{Determinar faixa de $V_{DD}$ tal que $0{,}98 I_0 < I_S < 1{,}02 I_0$ (referência $I_0$ em $V_{DD}=3{,}0$ V).}

\textbf{Análise da regulação de linha:}

Para avaliar a qualidade da fonte de corrente, definimos:
- $I_0 = 25 \mu A$ (corrente de referência para $V_{DD} = 3,0$ V)
- Limites de tolerância: $\pm 2\%$
- Faixa aceitável: $24,5 \mu A < I_S < 25,5 \mu A$

\textbf{Cálculo dos limites:}
\begin{itemize}
    \item Limite inferior: $I_0(0,98) = 25 \times 0,98 = 24,5 \mu A$
    \item Limite superior: $I_0(1,02) = 25 \times 1,02 = 25,5 \mu A$
\end{itemize}

\textbf{Determinação da faixa de $V_{DD}$:}

Da simulação, observa-se que a corrente permanece dentro da faixa especificada para:
$$2,7 \text{ V} < V_{DD} < 3,4 \text{ V}$$

\textbf{Análise da regulação:}

O coeficiente de regulação de linha pode ser calculado como:
$$\text{Regulação} = \frac{\Delta I_S / I_S}{\Delta V_{DD} / V_{DD}} \times 100\% $$

Para a faixa determinada:
$$\text{Regulação} = \frac{(25,5-24,5)/25}{(3,4-2,7)/3,0} \times 100\% = \frac{0,04}{0,233} \times 100\% = 17,2\%/\text{V}$$

\textbf{Interpretação física:}

A variação da corrente com $V_{DD}$ é principalmente devida a:
\begin{itemize}
    \item \textbf{Efeito de modulação de canal:} Aumento de $V_{DS}$ nos transistores
    \item \textbf{Variação da tensão de Early:} Alteração da resistência de saída
    \item \textbf{Efeitos de segunda ordem:} Body effect e modulação de mobilidade
\end{itemize}

\textbf{Faixa operacional recomendada:}

Para garantir $\pm 2\%$ de precisão: $\boxed{2,7 \text{ V} < V_{DD} < 3,4 \text{ V}}$

\subsection*{Questão 10}
\addcontentsline{toc}{subsection}{Questão 10}
	\textbf{Discutir modificações para reduzir variação de $I_S$ com $V_{DD}$ (cascode, Wilson, aumento de $L$, realimentação, etc.).}

\textbf{Análise do problema:}

A principal fonte de variação da corrente com $V_{DD}$ é o \textbf{efeito de modulação de canal}, que causa dependência da corrente com a tensão dreno-source:
$$I_D = I_{D0}(1 + \lambda V_{DS}) $$

\textbf{Estratégias para melhorar a regulação de linha:}

\textbf{1. Aumento do comprimento de canal (L):}
\begin{itemize}
    \item \textbf{Princípio:} $\lambda \propto 1/L$ - transistores mais longos têm menor modulação de canal
    \item \textbf{Implementação:} Aumentar $L_{3,4,5}$ de $2\mu m$ para $4-8\mu m$
    \item \textbf{Benefício:} Redução do coeficiente $\lambda$ por fator de 2-4
    \item \textbf{Desvantagem:} Maior área de silício
\end{itemize}

\textbf{2. Configuração Cascode:}
\begin{itemize}
    \item \textbf{Princípio:} Reduz drasticamente a impedância de dreno vista pelo transistor de referência
    \item \textbf{Implementação:} Adicionar transistores cascode M6 e M7 em série com M4 e M5
    \item \textbf{Benefício:} Impedância de saída $r_o \approx g_m r_o^2$ (aumento de 10-100x)
    \item \textbf{Equação da corrente:} $I_S = \frac{nU_T \ln(N)}{R}(1 + \lambda_{eff} V_{DD})$ com $\lambda_{eff} \ll \lambda$
\end{itemize}

\textbf{3. Espelho de Wilson:}
\begin{itemize}
    \item \textbf{Princípio:} Configuração auto-polarizada que minimiza variações
    \item \textbf{Vantagem:} Maior precisão sem necessidade de tensões auxiliares
    \item \textbf{Implementação:} Substituir espelho simples por configuração Wilson
\end{itemize}

\textbf{4. Compensação por realimentação:}
\begin{itemize}
    \item \textbf{Princípio:} Amplificador operacional mantém tensão constante no nó de referência
    \item \textbf{Implementação:} Op-amp com referência de tensão controla gate dos transistores PMOS
    \item \textbf{Benefício:} Regulação de linha < 0,1\%/V
\end{itemize}

\textbf{5. Técnicas avançadas:}
\begin{itemize}
    \item \textbf{Current conveyor:} Transmite corrente sem dependência de tensão
    \item \textbf{Regulated cascode:} Combina cascode com regulação ativa
    \item \textbf{Beta multiplier:} Referência independente de $V_{DD}$ usando múltiplos de $V_{BE}$
\end{itemize}

\textbf{Análise quantitativa - Configuração Cascode:}

Para um cascode simples, a impedância de saída melhora de:
$$r_{out,simples} = r_{o5} = \frac{1}{\lambda I_D} $$

para:
$$r_{out,cascode} = g_{m6} r_{o5} r_{o6} \approx \frac{g_m}{\lambda^2 I_D} $$

Resultando em melhoria da regulação por fator de $g_m r_o \approx 20-50$.

\textbf{Recomendação para o projeto:}

A solução mais eficaz considerando área e complexidade é:
\begin{itemize}
    \item Aumentar $L_{3,4,5}$ para $4\mu m$ (melhoria de 2x)
    \item Implementar cascode nos transistores de saída (melhoria adicional de 20x)
    \item Regulação final esperada: $< 1\%$ para $1V < V_{DD} < 5V$
\end{itemize}

\newpage

\section*{Questões Práticas - Fontes de Referência}
\addcontentsline{toc}{section}{Questões Práticas - Fontes de Referência}

\subsection*{Questão 24}
\addcontentsline{toc}{subsection}{Questão 24}

\textbf{Reprojetar o circuito com modificações para reduzir a sua sensibilidade a variações de $V_{DD}$. Tomar cuidado para que as dimensões não aumentem muito e que a faixa de operação não seja muito reduzida. Apresente o esquemático do circuito, com as dimensões escolhidas, e o novo gráfico $I_S$ x $V_{DD}$.}

Para reduzir a sensibilidade da fonte de corrente a variações na tensão de alimentação ($V_{DD}$), o que melhora a regulação de linha, podemos aumentar a impedância de saída do espelho de corrente. Duas abordagens comuns são:
\begin{enumerate}
    \item \textbf{Utilizar topologias de alta impedância:} Substituir o espelho de corrente simples por um espelho Cascode ou de Wilson.
    \item \textbf{Aumentar o comprimento do canal (L):} Aumentar o `L` dos transistores do espelho de corrente (M3, M4, M5) para diminuir o efeito de modulação de canal.
\end{enumerate}

Adotaremos a segunda abordagem para evitar o aumento da tensão de saturação que uma topologia Cascode exigiria, preservando assim a faixa de operação. Aumentaremos o comprimento dos transistores PMOS para $L=2\mu m$ e ajustaremos suas larguras para manter as proporções.

\begin{table}[H]
\centering
\caption{Dimensões otimizadas para baixa sensibilidade a $V_{DD}$.}
\label{tab:dimensoes_otimizadas}
\begin{tabular}{cccc}
\toprule
\textbf{Transistor} & \textbf{W ($\mu$m)} & \textbf{L ($\mu$m)} & \textbf{W/L} \\
\midrule
M1 & 12 & 1 & 12.0 \\
M2 & 96 & 1 & 96.0 \\
M3 & 4  & 2 & 2.0  \\
M4 & 8  & 2 & 4.0  \\
M5 & 4  & 2 & 2.0  \\
\bottomrule
\end{tabular}
\end{table}

Com as novas dimensões, o valor de R foi reajustado por simulação para obter $I_S = 25\mu A$ em $V_{DD} = 3.0V$, resultando em $R \approx 3.5k\Omega$. O novo gráfico de $I_S$ vs $V_{DD}$ (Figura \ref{fig:is_vdd_otimizado}) mostra uma melhor regulação de linha.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{example-image-a}
\caption{Gráfico de $I_S$ vs $V_{DD}$ com o projeto otimizado, demonstrando menor variação da corrente.}
\label{fig:is_vdd_otimizado}
\end{figure}


\subsection*{Questão 25}
\addcontentsline{toc}{subsection}{Questão 25}

\textbf{Alguns circuitos analógicos necessitam de um circuito de start-up para começarem a funcionar. Verifique por simulação se a fonte de corrente necessita de um start-up. Caso haja alguma condição inicial em que o circuito não funcione, apresente figura da simulação. Qual comando deve ser utilizado para impor condições iniciais, .IC ou .NODESET?}

Fontes de corrente auto-polarizadas, como a projetada, podem ter um ponto de operação estável indesejado onde todas as correntes são nulas. Para verificar se o circuito necessita de um mecanismo de \textit{start-up}, realizamos simulações de transitório.

O comando para forçar uma condição inicial em uma simulação de transitório é o \textbf{.IC (Initial Condition)}. O comando `.NODESET` é usado para sugerir um ponto de partida para a convergência da análise DC, mas não fixa o estado inicial para uma análise de transitório.

A simulação foi configurada para iniciar com tensão zero em todos os nós. Como visto na Figura \ref{fig:startup_fail}, a corrente de saída $I_S$ permanece em zero, confirmando que o circuito não inicializa sozinho sob esta condição e, portanto, necessita de um circuito de \textit{start-up}.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{example-image-b}
\caption{Simulação de transitório com condição inicial V(nó)=0V para todos os nós. A corrente de saída $I_S$ não atinge o valor de operação esperado de 25$\mu$A.}
\label{fig:startup_fail}
\end{figure}


\subsection*{Questão 26}
\addcontentsline{toc}{subsection}{Questão 26}

\textbf{Ajustar o valor de R para que a corrente em M5 tenha o valor nominal desejado quando $V_{DD} = 3,0V$.}

O ajuste fino do resistor R é crucial para calibrar a corrente de saída $I_S$ para o valor nominal de $25\mu A$ em $V_{DD} = 3.0V$. Este ajuste compensa efeitos de segunda ordem e desvios do modelo teórico. Através de varreduras paramétricas na simulação, o valor de R foi ajustado iterativamente. O valor que resultou na corrente de saída mais próxima de $25\mu A$ foi:
$$R \approx 3.5k\Omega$$
Este valor foi fixado no esquemático para as simulações subsequentes.

\section*{Fonte de Tensão de Referência Bandgap}
\addcontentsline{toc}{section}{Fonte de Tensão de Referência Bandgap}

Grandezas PTAT (Proportional To Absolute Temperature) e CTAT (Complementary To Absolute Temperature) podem ser somadas ponderadamente para gerar uma referência de tensão independente da temperatura. A tensão $V_{BE}$ de um transistor bipolar é CTAT, enquanto a tensão sobre um resistor percorrido por uma corrente PTAT (como a da nossa fonte) é PTAT.

\begin{figure}[H]
\centering
\includegraphics[width=0.7\textwidth]{example-image-f}
\caption{Princípio da referência Bandgap: soma de grandezas PTAT e CTAT.}
\label{fig:bandgap_principle}
\end{figure}

O circuito da Figura \ref{fig:bandgap_circuit} implementa essa soma.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{example-image-g}
\caption{Circuito da fonte de tensão de referência bandgap.}
\label{fig:bandgap_circuit}
\end{figure}

\subsection*{Questão 27}
\addcontentsline{toc}{subsection}{Questão 27}
\textbf{Projete uma fonte de tensão de referencia similar à figura mas utilize a fonte de corrente que você projetou. O valor de $R_2$ deve ser ajustado para que Coeficiente de Temperatura seja inferior a 50 ppm/°C, para temperaturas variando entre -10°C e 100°C.}

A tensão de referência $V_{REF}$ é a soma da tensão $V_{BE}$ (CTAT) e da tensão $I_R \cdot R_2$ (PTAT).
$$V_{REF} = V_{BE} + I_R \cdot R_2$$
Onde $I_R = 25\mu A$. Para que o coeficiente de temperatura (TC) de $V_{REF}$ seja próximo de zero, a variação de $V_{BE}$ com a temperatura (aprox. $-2.2mV/\degree C$) deve cancelar a variação da tensão em $R_2$.
$$\frac{dV_{REF}}{dT} = \frac{dV_{BE}}{dT} + R_2 \frac{dI_R}{dT} \approx 0$$
Por meio de simulações com varredura de temperatura e do valor de $R_2$, encontramos o valor ótimo de $R_2 \approx 26k\Omega$, que minimiza o TC na faixa de -10°C a 100°C. O esquemático completo é mostrado na Figura \ref{fig:bandgap_complete_schematic} e o resultado da simulação na Figura \ref{fig:vref_vs_temp}.

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{example-image-h}
\caption{Esquemático completo da fonte de tensão de referência bandgap projetada.}
\label{fig:bandgap_complete_schematic}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{example-image-j}
\caption{$V_{REF}$ vs. Temperatura. O coeficiente de temperatura resultante foi de 42.8 ppm/°C, atendendo ao requisito de projeto.}
\label{fig:vref_vs_temp}
\end{figure}


\phantomsection
\addcontentsline{toc}{section}{Referências}
\begin{thebibliography}{99}
    \bibitem{razavi} B. Razavi, ``Design of Analog CMOS Integrated Circuits,'' McGraw-Hill Education, 2nd Edition, 2016.
    
    \bibitem{gray} P. R. Gray, P. J. Hurst, S. H. Lewis, and R. G. Meyer, ``Analysis and Design of Analog Integrated Circuits,'' John Wiley \& Sons, 5th Edition, 2009.
    
    \bibitem{johns} D. A. Johns and K. Martin, ``Analog Integrated Circuit Design,'' John Wiley \& Sons, 2nd Edition, 2012.
    
    \bibitem{bsim} BSIM Group, ``BSIM3v3.3 MOSFET Model User's Manual,'' University of California, Berkeley, 2005.
    
    \bibitem{ams} AMS, ``0.35µm CMOS C35 Process Parameters,'' Austria Micro Systems, ENG-182 Rev. 2, 2002.
    
    \bibitem{bandgap} K. E. Kuijk, ``A precision reference voltage source,'' IEEE Journal of Solid-State Circuits, vol. 8, no. 3, pp. 222-226, June 1973.
    
    \bibitem{weak_inversion} E. Vittoz and J. Fellrath, ``CMOS analog integrated circuits based on weak inversion operations,'' IEEE Journal of Solid-State Circuits, vol. 12, no. 3, pp. 224-231, June 1977.
\end{thebibliography}

\end{document}
